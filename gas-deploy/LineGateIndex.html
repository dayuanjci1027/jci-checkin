<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <style>
      /* =========================================
         0. å…¨åŸŸèˆ‡ JCI é…è‰²
         ========================================= */
      :root {
        --jci-blue: #0097D7;
        --jci-navy: #003C88;
        --jci-green: #28a745;
        --jci-red: #dc3545; /* æ–°å¢ç´…è‰²ç”¨æ–¼ç™»å‡º */
        --bg-color: #f3f6f9;
        --text-dark: #1a1a1a;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-color); margin: 0; padding: 0; color: var(--text-dark);
        -webkit-tap-highlight-color: transparent;
      }

      /* =========================================
         1. ç™»å…¥ä»‹é¢
         ========================================= */
      #login-view {
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: #fff; z-index: 10;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        overflow-y: auto;
      }
      
      .login-banner {
        width: 100%; height: 260px;
        background: linear-gradient(135deg, var(--jci-navy) 0%, var(--jci-blue) 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,60,136,0.3);
        transition: height 0.3s ease; /* åŠ å…¥å‹•ç•« */
      }
      .banner-icon {
        font-size: 50px; margin-bottom: 15px; background: rgba(255,255,255,0.2);
        width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      }
      .banner-title { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
      .banner-subtitle { font-size: 14px; opacity: 0.9; }
      
      .login-form { width: 85%; max-width: 360px; display: flex; flex-direction: column; gap: 16px; }
      .input-label { font-size: 14px; color: var(--jci-navy); font-weight: 600; margin-bottom: 6px; display: block; }
      .login-input {
        width: 100%; padding: 14px; font-size: 16px; border: 1px solid #e0e6ed;
        border-radius: 10px; box-sizing: border-box; outline: none; background: #f8faff;
      }
      .login-input:focus { border-color: var(--jci-blue); background: #fff; }
      .login-btn {
        margin-top: 10px; width: 100%; padding: 14px; font-size: 18px; font-weight: 600;
        color: white; background: var(--jci-navy); border: none; border-radius: 10px; cursor: pointer;
      }
      .error-msg { color: #ff3b3b; font-size: 14px; text-align: center; font-weight: bold; margin-top: 5px; }
      
      /* =========================================
         2. æˆåŠŸè·³è½‰å€
         ========================================= */
      #redirect-area {
        display: none; width: 100%; flex-direction: column; align-items: center;
        margin-top: 20px; animation: fadeIn 0.5s;
      }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      .success-text {
        font-size: 20px; font-weight: bold; color: var(--jci-navy); margin-bottom: 20px;
        text-align: center;
      }

      .btn-go-target {
        display: flex; align-items: center; justify-content: center;
        background: var(--jci-green); color: white;
        text-decoration: none; width: 100%; padding: 16px; border-radius: 12px;
        font-size: 18px; font-weight: bold;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        transition: transform 0.1s;
      }
      .btn-go-target:active { transform: scale(0.98); }
      .btn-go-target span { margin-right: 8px; font-size: 24px; }

      /* =========================================
         3. ç™»å‡ºæŒ‰éˆ• (æ–°å¢)
         ========================================= */
      .logout-link {
        margin-top: 20px; color: #999; font-size: 14px; text-decoration: underline; cursor: pointer;
      }
      .logout-link:hover { color: var(--jci-red); }

    </style>

    <script>
      // å¾Œç«¯å‚³ä¾†çš„é©—è­‰è³‡æ–™
      var membersData = <?!= JSON.stringify(members) ?>;

      // â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
      var targetUrl = 'https://line.me/R/ti/p/@265jvlrx'; 
      var STORAGE_KEY = 'JCI_MEMBER_AUTH_V1'; // localStorage çš„ Key

      // é é¢è¼‰å…¥æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰èˆŠç´€éŒ„
      window.onload = function() {
        checkAutoLogin();
      };

      // æª¢æŸ¥ localStorage æ˜¯å¦æœ‰å„²å­˜çš„å¸³å¯†
      function checkAutoLogin() {
        var storedAuth = localStorage.getItem(STORAGE_KEY);
        if (storedAuth) {
          try {
            var authData = JSON.parse(storedAuth);
            // å˜—è©¦ä½¿ç”¨å„²å­˜çš„è³‡æ–™é€²è¡Œé©—è­‰ (ä¸é¡¯ç¤º alert éŒ¯èª¤)
            validateMember(authData.acc, authData.pwd, true);
          } catch (e) {
            console.error("Local storage parse error", e);
            localStorage.removeItem(STORAGE_KEY);
          }
        }
      }

      // æŒ‰ä¸‹ç™»å…¥æŒ‰éˆ•
      function attemptLogin() {
        var accInput = document.getElementById("login-acc").value.trim().toUpperCase();
        var pwdInput = document.getElementById("login-pwd").value.trim();
        var errorDiv = document.getElementById("login-error");

        if (!accInput || !pwdInput) {
          errorDiv.textContent = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"; return;
        }

        // å‘¼å«é©—è­‰é‚è¼¯ (fromManual = true è¡¨ç¤ºæ˜¯æ‰‹å‹•è¼¸å…¥ï¼Œè¦å­˜æª”)
        validateMember(accInput, pwdInput, false);
      }

      // æ ¸å¿ƒé©—è­‰é‚è¼¯
      function validateMember(acc, pwd, isAutoLogin) {
        var errorDiv = document.getElementById("login-error");
        var found = false;
        var memberName = "";
        var isFormerMember = false;

        // æ¯”å°è³‡æ–™
        for (var i = 0; i < membersData.length; i++) {
          var m = membersData[i];
          if (m.a === acc && m.p === pwd) {
            if (m.r && m.r.indexOf('å‰æœƒå“¡') !== -1) {
              isFormerMember = true; 
              break;
            }
            found = true; 
            memberName = m.n; 
            break;
          }
        }

        // è™•ç†å‰æœƒå“¡
        if (isFormerMember) {
          if (!isAutoLogin) {
            errorDiv.textContent = "æŠ±æ­‰ï¼Œå‰æœƒå“¡ç„¡æ³•å­˜å–æ­¤é é¢";
            document.getElementById("login-pwd").value = "";
          } else {
            // å¦‚æœæ˜¯è‡ªå‹•ç™»å…¥ç™¼ç¾è®Šæˆäº†å‰æœƒå“¡ï¼Œæ¸…é™¤ç´€éŒ„
            logout();
          }
          return;
        }

        // é©—è­‰æˆåŠŸ
        if (found) {
          // 1. å¯«å…¥å¾Œç«¯ç´€éŒ„
          if (!isAutoLogin) {
             // åªæœ‰æ‰‹å‹•ç™»å…¥æ™‚æ‰å¯«å…¥ Logï¼Œé¿å…æ¯æ¬¡é‡æ–°æ•´ç†éƒ½å¯«å…¥ (è¦–éœ€æ±‚è€Œå®š)
             google.script.run.recordAccessLog(memberName, acc);
          }
          
          // 2. å¦‚æœæ˜¯æ‰‹å‹•ç™»å…¥ï¼Œå°‡è³‡æ–™å­˜å…¥ localStorage
          if (!isAutoLogin) {
            var authData = { acc: acc, pwd: pwd, timestamp: new Date().getTime() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(authData));
          }

          // 3. åˆ‡æ›ä»‹é¢
          switchToSuccessView(memberName);

        } else {
          // é©—è­‰å¤±æ•—
          if (!isAutoLogin) {
            errorDiv.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
            document.getElementById("login-pwd").value = "";
          } else {
            // è‡ªå‹•ç™»å…¥å¤±æ•— (å¯èƒ½æ”¹å¯†ç¢¼äº†)ï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥é 
            console.log("Auto login failed, credentials invalid.");
            localStorage.removeItem(STORAGE_KEY);
          }
        }
      }

      // åˆ‡æ›åˆ°æˆåŠŸç•«é¢
      function switchToSuccessView(name) {
        var formArea = document.querySelector(".login-form");
        var redirectArea = document.getElementById("redirect-area");
        var bannerSub = document.querySelector(".banner-subtitle");
        var bannerIcon = document.querySelector(".banner-icon");
        var btn = document.getElementById("go-btn");

        // éš±è—è¡¨å–®
        formArea.style.display = "none";
        
        // æ›´æ–° Banner
        bannerSub.textContent = "æ­¡è¿æ‚¨ï¼Œ" + name;
        bannerIcon.textContent = "ğŸ‘‹"; // æ›å€‹åœ–ç¤º
        
        // è¨­å®šé€£çµ
        btn.href = targetUrl;
        
        // é¡¯ç¤ºè·³è½‰å€
        redirectArea.style.display = "flex";
      }

      // ç™»å‡ºåŠŸèƒ½
      function logout() {
        if(confirm("ç¢ºå®šè¦åˆ‡æ›å¸³è™Ÿ/ç™»å‡ºå—ï¼Ÿ")) {
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      }

    </script>
  </head>

  <body>
    <div id="login-view">
      <div class="login-banner">
        <div class="banner-icon">ğŸ”’</div>
        <div class="banner-title">æœƒå“¡é©—è­‰</div> 
        <div class="banner-subtitle">è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿèˆ‡å‡ºç”Ÿå¹´æœˆæ—¥</div>
      </div>

      <div class="login-form">
        <label class="input-label">èº«åˆ†è­‰å­—è™Ÿ (å¸³è™Ÿ)</label>
        <input type="text" id="login-acc" class="login-input" placeholder="ä¾‹å¦‚ï¼šA123456789" 
               oninput="this.value = this.value.toUpperCase()" style="text-transform:uppercase;">
        <label class="input-label">è¥¿å…ƒå‡ºç”Ÿå¹´æœˆæ—¥ (å¯†ç¢¼)</label>
        <input type="password" id="login-pwd" class="login-input" placeholder="è¥¿å…ƒ8ç¢¼ ä¾‹å¦‚ï¼š19900101">
        
        <div id="login-error" class="error-msg"></div>
        <button class="login-btn" onclick="attemptLogin()">é©—è­‰èº«åˆ†</button>
      </div>

      <div id="redirect-area" class="login-form">
        <div class="success-text">é©—è­‰æˆåŠŸï¼</div>
        <a id="go-btn" href="#" class="btn-go-target" target="_blank">
          <span>ğŸš€</span> é»æ­¤å‰å¾€
        </a>
        
        <div class="logout-link" onclick="logout()">åˆ‡æ›å¸³è™Ÿ / ç™»å‡º</div>
      </div>

    </div>
  </body>
</html>