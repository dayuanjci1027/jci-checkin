<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大園青商 - 外會來賓預約簽到</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --jci-blue: #0097D7; --jci-dark: #005780; --bg-gradient: linear-gradient(135deg, #0097D7 0%, #005780 100%); }
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 450px; text-align: center; margin: 20px auto; }
        .logo-text { font-size: 1.8rem; font-weight: bold; color: var(--jci-blue); margin-bottom: 5px; }
        .sub-text { color: #666; margin-bottom: 25px; }
        .form-group { text-align: left; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        input:focus { border-color: var(--jci-blue); outline: none; }
        .btn-submit { width: 100%; padding: 15px; background: var(--bg-gradient); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        #photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: none; border: 3px solid var(--jci-blue); }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo-text">JCI 大園青年商會</div>
        <div id="event-name" class="sub-text">外會來賓預約報到系統</div>
        <form id="invite-form">
            <div class="form-group">
                <label>青商會友請填：所屬分會</label>
                <input type="text" id="chapter" placeholder="例如：大園青商 (若非會友請留空)">
            </div>
            <div class="form-group">
                <label>非青商會友請填：所屬單位</label>
                <input type="text" id="organization" placeholder="例如：桃園市政府 (若為會友請留空)">
            </div>
            <div class="form-group">
                <label>職稱</label>
                <input type="text" id="title" placeholder="例如：會長 / 秘書長 / 科長" required>
            </div>
            <div class="form-group">
                <label>姓名</label>
                <input type="text" id="name" placeholder="請輸入姓名" required>
            </div>
            <div class="form-group">
                <label>Email (寄送 QR Code 用)</label>
                <input type="email" id="email" placeholder="example@mail.com" required>
            </div>
            <div class="form-group">
                <label>上傳照片</label>
                <input type="file" id="photo" accept="image/*" required>
                <img id="photo-preview" src="">
            </div>
            <button type="submit" class="btn-submit" id="submit-btn">提交預約</button>
        </form>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 蝦霸更新：這是最新版本的 GAS 連結 (v40 蝦霸更新)
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwzuFSiq9SD6qcIYzHTxHAEN3ToI6H9G9vhELnaaJpP0WkGsccf8G571vX0RAj_kp7_lw/exec";

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event');

        if (!eventId) {
            Swal.fire("錯誤", "網址無效，缺少會議 ID", "error");
            document.getElementById('submit-btn').disabled = true;
        } else {
            db.ref('events_meta/' + eventId).once('value', snap => {
                if (snap.exists()) {
                    document.getElementById('event-name').innerText = "歡迎蒞臨：" + snap.val().name;
                } else {
                    Swal.fire("錯誤", "找不到該會議資訊", "error");
                    document.getElementById('submit-btn').disabled = true;
                }
            });
        }

        document.getElementById('photo').onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const preview = document.getElementById('photo-preview');
                    preview.src = evt.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('invite-form').onsubmit = async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerText = "處理中...";

            const chapter = document.getElementById('chapter').value;
            const organization = document.getElementById('organization').value;
            const title = document.getElementById('title').value;
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const photoFile = document.getElementById('photo').files[0];

            try {
                const base64Photo = await toBase64(photoFile);
                
                let finalGroup = "External";
                let displayUnit = chapter;
                if (organization && !chapter) {
                    finalGroup = "Officials";
                    displayUnit = organization;
                }

                // 蝦霸修正：改用 JSONP 模式或更霸氣的 POST 處理
                // 因為 no-cors 無法獲取響應，但可以成功觸發
                const payload = {
                    action: 'register',
                    eventId: eventId,
                    chapter: displayUnit,
                    title: title,
                    name: name,
                    email: email,
                    group: finalGroup,
                    photoData: base64Photo.split(',')[1],
                    photoType: photoFile.type
                };

                // 1. 先寫入 Firebase (這才是真正讓現場掃碼能動的關鍵！)
                // 蝦霸修正：使用 timestamp 避免同名覆蓋
                const uniqueId = Date.now().toString().slice(-6);
                const visitorId = `${name}_${uniqueId}`; 
                await db.ref('events_data/' + eventId + '/' + visitorId).set({
                    id: visitorId,
                    name: name,
                    // 這裡的 title 會是掃碼時顯示的內容，建議合併顯示
                    title: (displayUnit ? displayUnit + ' ' : '') + title,
                    arrived: false,
                    photo: base64Photo, // 直接把 Base64 存進 Firebase 顯示用 (會比較大，但保證即時)
                    email: email,
                    isGuest: true,
                    group: finalGroup,
                    timestamp: 0,
                    originalIndex: 9999 // 排在後面
                });

                // 2. 同步發送給 GAS (寄信 + 備份到 Google Sheet)
                // 使用 no-cors 模式發送，不等待回應 (Fire and Forget)
                // 蝦霸備註: 這裡故意用 text/plain 避免触发 CORS preflight
                fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                }).then(() => console.log("GAS Sync initiated"))
                  .catch(e => console.error("GAS Backup Error:", e));

                // 3. 直接顯示成功，不依賴 GAS 回應
                Swal.fire({
                    icon: 'success',
                    title: '預約成功',
                    text: 'QR Code 已寄送至您的信箱，請查收！(若沒看到請檢查垃圾信箱)',
                    confirmButtonText: '太棒了'
                }).then(() => location.reload());

            } catch (err) {
                console.error(err);
                Swal.fire("錯誤", "提交失敗，請洽秘書處", "error");
                submitBtn.disabled = false;
                submitBtn.innerText = "提交預約";
            }
        };

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
