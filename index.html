<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCI æ´»å‹•ç®¡ç†ç³»çµ± V1.1 (è¼¸å‡ºå…¥ç«¯èª¿æ•´ç‰ˆ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --jci-blue: #0097D7; /* é’å•†è— */
            --jci-dark: #005780;
            --accent: #FFC107; 
            --bg-gradient: linear-gradient(135deg, #0097D7 0%, #005780 100%);
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            margin: 0; 
            background: #f0f2f5; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        #nav-bar { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            z-index: 100; 
            position: sticky; top: 0;
        }
        .hide-nav { display: none !important; }

        .nav-group { display: flex; gap: 5px; }
        .nav-item { 
            cursor: pointer; color: #666; font-weight: 500; 
            padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; 
            transition: all 0.3s ease; 
        }
        .nav-item.active { 
            background: var(--jci-blue); color: white; box-shadow: 0 2px 10px rgba(0,151,215,0.3);
        }
        .event-badge { 
            background: #333; color: white; padding: 6px 15px; border-radius: 20px; 
            font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }

        /* --- é é¢å®¹å™¨ --- */
        .page { display: none; flex: 1; overflow-y: auto; padding: 20px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- æœƒå“¡ç™»å…¥ä»‹é¢ --- */
        .login-bg {
            display: flex; align-items: center; justify-content: center;
            min-height: 80vh;
        }
        .login-card { 
            background: white; 
            width: 100%; max-width: 380px; 
            padding: 40px; 
            border-radius: 24px; 
            text-align: center; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
            position: relative;
            overflow: hidden;
        }
        .login-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: var(--bg-gradient);
        }
        .login-title { font-size: 1.8rem; font-weight: 700; color: #333; margin-bottom: 5px; }
        .login-subtitle { font-size: 0.9rem; color: #888; margin-bottom: 30px; }

        .input-group { text-align: left; margin-bottom: 20px; }
        .input-label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: bold; }
        .styled-input { 
            width: 100%; padding: 14px 16px; 
            border: 2px solid #eee; border-radius: 12px; 
            font-size: 1rem; transition: 0.3s; box-sizing: border-box;
        }
        .styled-input:focus { 
            border-color: var(--jci-blue); outline: none; background: #f9fcff; 
        }

        .btn-gradient { 
            width: 100%; padding: 16px; 
            background: var(--bg-gradient); color: white; 
            border: none; border-radius: 12px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; 
            transition: 0.3s; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,151,215,0.3);
        }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,151,215,0.4); }

        #pass-area { 
            display: none; margin-top: 20px; 
            border: 2px dashed #0097D7; padding: 20px; border-radius: 15px; background: #f0f9ff;
        }

        /* --- æ«ƒå°èˆ‡å…¶ä»–ä»‹é¢ --- */
        .event-card { 
            background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #eee; cursor: pointer;
            transition: 0.2s;
        }
        .event-card.active { background: #e3f2fd; border-color: var(--jci-blue); }

        /* è¼¸å…¥ç«¯åˆ—è¡¨æ¨£å¼ */
        .guest-item {
            background: white; padding: 15px; border-bottom: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .guest-item.arrived { background: #f9f9f9; }
        /* è¼¸å…¥ç«¯ç…§ç‰‡æ¨£å¼ */
        .guest-photo-small {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
            border: 2px solid #eee; margin-right: 12px;
        }

        /* æµ®å‹•æŒ‰éˆ• */
        .fab { 
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; 
            background: var(--jci-blue); color: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 2rem; 
            box-shadow: 0 4px 20px rgba(0,151,215,0.4); cursor: pointer; z-index: 200; transition: 0.3s; 
        }

        #site-qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #site-qr-box { background: white; padding: 40px; border-radius: 20px; text-align: center; }

        /* --- â˜…â˜…â˜… è¼¸å‡ºç«¯ (Dashboard) ä¿®æ”¹ç‰ˆ â˜…â˜…â˜… --- */
        #dashboard-grid {
            display: flex; flex-wrap: wrap; justify-content: flex-start; align-content: flex-start; gap: 15px;
            padding: 10px;
        }

        /* çµ±ä¸€å¡ç‰‡æ¨£å¼ (ä¸åˆ†å¤§å°ï¼Œåªåˆ†é¡è‰²) */
        .vip-card { 
            background: white; padding: 15px; border-radius: 12px; text-align: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            position: relative; overflow: hidden;
            width: 180px; /* å›ºå®šå¯¬åº¦ï¼Œè®“å®ƒè‡ªå‹•æ›è¡Œ */
            flex-grow: 1; /* å…è¨±ç¨å¾®æ’é–‹å¡«æ»¿ */
            max-width: 220px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            transition: 0.3s; 
            border: 3px solid transparent; /* é ç•™é‚Šæ¡†ä½ç½® */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .avatar { 
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover; 
            margin-bottom: 10px; border: 3px solid #f0f2f5; 
        }

        /* å‰›å ±åˆ° (New) - åªæ”¹è®Šé‚Šæ¡†é¡è‰²ï¼Œä¸æ”¾å¤§ */
        .vip-card.new-arrival {
            border-color: #FFC107; /* é»ƒè‰²é‚Šæ¡† */
            background: #fffceb;   /* æ·¡æ·¡é»ƒåº• */
            animation: pulseBorder 2s infinite;
        }

        @keyframes pulseBorder {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .swal2-input { font-size: 1rem !important; }

    </style>
</head>
<body>

    <div id="nav-bar">
        <div class="event-badge" onclick="goPage('home')" id="current-event-display">
            <span>ğŸ </span> å°šæœªé¸æ“‡æ´»å‹•
        </div>
        <div class="nav-group">
            <div class="nav-item" onclick="goPage('member')">æœƒå“¡</div>
            <div class="nav-item" onclick="goPage('reception')">è¼¸å…¥ç«¯</div>
            <div class="nav-item" onclick="goPage('dashboard')">è¼¸å‡ºç«¯</div>
        </div>
    </div>

    <div id="page-home" class="page active">
        <h2 style="color:#333; margin: 10px 0 20px;">ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
        <div id="event-list">è¼‰å…¥ä¸­...</div>
        <div class="fab" onclick="createNewEvent()">+</div>
        
        <div style="text-align:center; margin-top:40px;">
            <button onclick="showSiteQR()" style="background:white; border:1px solid #ddd; padding:10px 20px; border-radius:30px; cursor:pointer; font-weight:bold; color:#555; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                ğŸ“± é¡¯ç¤ºå…¥å ´æƒæç”¨ QR Code
            </button>
        </div>
    </div>

    <div id="page-member" class="page">
        <div class="login-bg">
            <div class="login-card">
                <div style="font-size:3rem; margin-bottom:10px;">ğŸ†”</div>
                
                <div class="login-title">æœƒå“¡å ±åˆ°ç³»çµ±</div>
                <div class="login-subtitle">JCI Member Check-in</div>
                
                <div id="login-form">
                    <div class="input-group">
                        <label class="input-label">èº«åˆ†è­‰å­—è™Ÿ</label>
                        <input type="text" id="login-id" class="styled-input" placeholder="ä¾‹å¦‚ï¼šA123456789">
                    </div>
                    <div class="input-group">
                        <label class="input-label">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                        <input type="text" id="login-dob" class="styled-input" placeholder="ä¾‹å¦‚ï¼š19920101">
                    </div>
                    <button id="btn-verify" class="btn-gradient" onclick="verifyWithGoogle()">ç¢ºèªç™»å…¥</button>
                </div>

                <div id="pass-area">
                    <img id="pass-photo" class="avatar" style="width:100px; height:100px;" src="">
                    <div style="font-size:0.9rem; color:#666;">WELCOME</div>
                    <div id="pass-name" style="font-weight:bold; color:var(--jci-dark); font-size:1.5rem; margin-bottom:5px;"></div>
                    <div id="pass-title" style="color:#888; font-size:0.9rem; margin-bottom:15px;"></div>
                    
                    <div id="qrcode" style="display:inline-block; border: 8px solid white; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-radius: 10px;"></div>
                    
                    <div style="margin-top:15px; padding:10px; background:#fff3cd; color:#856404; font-size:0.8rem; border-radius:8px;">
                        è«‹æˆªåœ–æ­¤ç•«é¢ï¼Œæ–¼å…¥å ´è™•å‡ºç¤º
                    </div>
                    <button onclick="location.reload()" style="background:none; border:none; color:#999; margin-top:15px; cursor:pointer; text-decoration:underline;">é‡æ–°ç™»å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-reception" class="page">
        <h2 style="margin-bottom:20px;">è¼¸å…¥ç«¯ (åŸæ«ƒå°)</h2>
        
        <button id="btn-cam" class="btn-gradient" style="background:linear-gradient(45deg, #ff5722, #ff9800); margin-bottom:20px;" onclick="toggleCamera()">ğŸ“· æƒæ QR Code</button>
        
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; border:1px solid #eee;">
            <button onclick="addNewGuest()" style="background:var(--jci-blue); color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; flex:1;">â• æ–°å¢ç¾å ´ä¾†è³“</button>
            
            <button onclick="syncFromCloud()" style="background:#007bff; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">â˜ï¸ åŒæ­¥åå–®</button>
            <button onclick="exportCSV()" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“¥ åŒ¯å‡ºç´€éŒ„</button>
            <button onclick="deleteEvent()" style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2; padding:10px 15px; border-radius:8px; cursor:pointer; margin-left:auto;">ğŸ—‘ï¸ é‡ç½®</button>
        </div>

        <div id="scanner-view" style="display:none; background:black; padding:10px; border-radius:15px; margin-bottom:20px; overflow:hidden;">
            <div id="reader"></div>
        </div>
        
        <div style="position:relative; margin-bottom:15px;">
            <input type="text" id="search-box" placeholder="ğŸ” æœå°‹åå–®..." class="styled-input" onkeyup="renderReception()">
        </div>
        <div id="reception-list"></div>
    </div>

    <div id="page-dashboard" class="page" style="background-color: #222; min-height: 100vh;">
        <h2 style="color:white; margin:0 0 20px 10px;">è¼¸å‡ºç«¯ (è²´è³“ç‰†)</h2>
        <div id="empty-msg" style="color:#777; text-align:center; margin-top:20%; font-size:1.5rem; display:none;">
            ç­‰å¾…è²´è³“è’è‡¨...
        </div>
        <div id="dashboard-grid"></div>
    </div>

    <div id="site-qr-modal" onclick="this.style.display='none'">
        <div id="site-qr-box" onclick="event.stopPropagation()">
            <h2 style="margin:0 0 10px 0; color:var(--jci-blue);">æœƒå“¡æƒç¢¼å…¥å ´</h2>
            <div id="site-qrcode" style="margin:20px;"></div>
            <p style="color:#666; font-size:0.9rem;">è«‹æƒææ­¤ç¢¼ç™»å…¥é ˜å–é›»å­é€šè¡Œè­‰</p>
        </div>
    </div>

    <script>
        // ==========================================
        // â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db",
            measurementId: "G-SDY39SN348"
        };
        // â˜… è«‹å‹™å¿…ç¢ºèªæ‚¨çš„ GAS ç¶²å€ (å¦‚æœé‡æ–°éƒ¨ç½²éï¼Œè«‹æ›´æ–°é€™è£¡)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyT00r1ap5CkHkuyj3htQ0-AuU65CkidhsxWftaNjWe_9iPgKs6HlaLfqBDPqkV2dUDMQ/exec";
        // ==========================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        let currentEventId = null;
        let guestsData = {};
        let allEvents = {};
        let scanner = null;
        let isScanning = false;

        // åˆå§‹åŒ–
        db.ref('events_meta').on('value', snap => { allEvents = snap.val() || {}; renderEventList(); });

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'entry') {
                document.getElementById('nav-bar').classList.add('hide-nav');
                goPage('member');
            }
        };

        // å°èˆª
        function goPage(p) {
            if (!currentEventId && p !== 'home' && p !== 'member') return Swal.fire("è«‹å…ˆåœ¨æ´»å‹•å¤§å»³é¸æ“‡ä¸€å€‹æ´»å‹•");
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            const navMap = {'member':0, 'reception':1, 'dashboard':2};
            if(navMap[p] !== undefined) document.querySelectorAll('.nav-item')[navMap[p]].classList.add('active');

            if(p !== 'reception') stopCamera();
        }

        // P0. æ´»å‹•å¤§å»³
        function createNewEvent() {
            Swal.fire({ title: 'å»ºç«‹æ–°æ´»å‹•', input: 'text', showCancelButton: true }).then((r) => {
                if (r.isConfirmed && r.value) {
                    const id = 'evt_' + Date.now();
                    db.ref('events_meta/' + id).set({ id: id, name: r.value, created: Date.now() });
                    selectEvent(id, r.value);
                }
            });
        }
        function renderEventList() {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            Object.values(allEvents).sort((a,b)=>b.created-a.created).forEach(evt => {
                const div = document.createElement('div');
                div.className = `event-card ${evt.id === currentEventId ? 'active' : ''}`;
                div.innerHTML = `<div><div style="font-weight:bold">${evt.name}</div><div style="font-size:0.8rem;color:#888">${new Date(evt.created).toLocaleDateString()}</div></div><button onclick="selectEvent('${evt.id}','${evt.name}')" style="background:var(--jci-blue);color:white;border:none;padding:6px 15px;border-radius:20px;cursor:pointer">é€²å…¥</button>`;
                list.appendChild(div);
            });
        }
        function selectEvent(id, name) {
            currentEventId = id;
            document.getElementById('current-event-display').innerHTML = `<span>ğŸ“…</span> ${name}`;
            db.ref(`events_data/${id}`).off();
            db.ref(`events_data/${id}`).on('value', snap => {
                guestsData = snap.val() || {};
                renderReception();
                renderDashboard();
            });
            goPage('reception');
        }
        function deleteEvent() {
            if(!currentEventId || !confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ")) return;
            db.ref(`events_meta/${currentEventId}`).remove();
            db.ref(`events_data/${currentEventId}`).remove();
            currentEventId = null;
            document.getElementById('current-event-display').innerHTML = "<span>ğŸ </span> å°šæœªé¸æ“‡æ´»å‹•";
            goPage('home');
        }

        // P1. æœƒå“¡é©—è­‰
        function verifyWithGoogle() {
            const id = document.getElementById('login-id').value.trim().toUpperCase();
            const dob = document.getElementById('login-dob').value.trim();
            const btn = document.getElementById('btn-verify');
            if (!id || !dob) return Swal.fire("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            
            btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
            fetch(`${GOOGLE_SCRIPT_URL}?id=${id}&dob=${dob}`).then(r => r.json()).then(d => {
                btn.innerText = "ç¢ºèªç™»å…¥"; btn.disabled = false;
                if (d.status === 'success') {
                    document.getElementById('login-form').style.display='none';
                    document.getElementById('pass-area').style.display='block';
                    document.getElementById('pass-name').innerText = d.name;
                    document.getElementById('pass-title').innerText = d.title;
                    document.getElementById('pass-photo').src = d.photo || defaultAvatar;
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById('qrcode'), { text: d.uid, width: 180, height: 180, colorDark : "#005780" });
                } else { Swal.fire("é©—è­‰å¤±æ•—", "è³‡æ–™ä¸ç¬¦", "error"); }
            }).catch(()=> { btn.innerText="ç¢ºèªç™»å…¥"; btn.disabled=false; Swal.fire("é€£ç·šéŒ¯èª¤", "è«‹æª¢æŸ¥ç¶²è·¯", "error"); });
        }

        // P2. è¼¸å…¥ç«¯ (åŸæ«ƒå°)
        function toggleCamera() { isScanning ? stopCamera() : startCamera(); }
        function startCamera() {
            document.getElementById('scanner-view').style.display = 'block';
            document.getElementById('btn-cam').innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
            document.getElementById('btn-cam').style.background = "#333";
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(onScanSuccess);
            isScanning = true;
        }
        function stopCamera() {
            if(scanner) { scanner.clear(); scanner = null; }
            document.getElementById('scanner-view').style.display = 'none';
            document.getElementById('btn-cam').innerText = "ğŸ“· æƒæ QR Code";
            document.getElementById('btn-cam').style.background = "linear-gradient(45deg, #ff5722, #ff9800)";
            isScanning = false;
        }
        function onScanSuccess(uid) {
            if(guestsData[uid]) {
                if(!guestsData[uid].arrived) {
                    checkIn(uid, true);
                    Swal.fire({ icon: 'success', title: guestsData[uid].name, text: 'ç°½åˆ°æˆåŠŸ', timer: 1000, showConfirmButton: false });
                } else { Swal.fire("é‡è¤‡", "å·²å…¥å ´", "warning"); }
            } else { Swal.fire("éŒ¯èª¤", "éæœ¬å ´åå–®", "error"); }
        }

        // â˜…â˜…â˜… ä¿®æ”¹ 2: è¼¸å…¥ç«¯åˆ—è¡¨åŠ å…¥ç…§ç‰‡ â˜…â˜…â˜…
        function renderReception() {
            const list = document.getElementById('reception-list');
            const search = document.getElementById('search-box').value.toUpperCase();
            list.innerHTML = '';
            
            Object.values(guestsData).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).forEach(g => {
                if(search && g.name.indexOf(search) === -1) return;
                
                const d = document.createElement('div');
                d.className = `guest-item ${g.arrived ? 'arrived' : ''}`;
                
                // åŠ å…¥ç…§ç‰‡ä¸¦ä½¿ç”¨ Flex æ’ç‰ˆ
                d.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <img src="${g.photo || defaultAvatar}" class="guest-photo-small">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${g.name}</div>
                            <div style="font-size:0.8rem;color:#666">${g.title} | ${g.group}</div>
                        </div>
                    </div>
                    <button onclick="checkIn('${g.id}',${!g.arrived})" style="padding:6px 15px;border:none;border-radius:20px;cursor:pointer;background:${g.arrived?'#ccc':'var(--jci-blue)'};color:white;font-weight:bold;">
                        ${g.arrived?'å–æ¶ˆ':'ç°½åˆ°'}
                    </button>
                `;
                list.appendChild(d);
            });
        }
        
        function checkIn(id, status) {
            const updates = {
                arrived: status,
                timestamp: status ? firebase.database.ServerValue.TIMESTAMP : 0,
                acked: status ? false : null 
            };
            db.ref(`events_data/${currentEventId}/${id}`).update(updates);
        }

        // â˜…â˜…â˜… ä¿®æ”¹ 3: è¼¸å‡ºç«¯ç§»é™¤å½ˆå‡ºï¼Œæ”¹ç‚ºå–®ç´”æ ¼ç‹€æ’åˆ— â˜…â˜…â˜…
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            const emptyMsg = document.getElementById('empty-msg');
            grid.innerHTML = '';
            
            // 1. éæ¿¾ (é‚è¼¯ä¸è®Š)
            let list = Object.values(guestsData).filter(g => {
                if (!g.arrived) return false;
                if (g.group === 'External' || g.group === 'Official') return true;
                if ((g.group === 'Internal' || g.group === 'internal') && g.title) {
                      if (g.title.indexOf('æœƒé•·') > -1 || g.title.indexOf('ä¸»å¸­') > -1) return true;
                }
                return false;
            });

            if (list.length === 0) {
                emptyMsg.style.display = 'block'; return;
            } else {
                emptyMsg.style.display = 'none';
            }

            // 2. æ’åºï¼šæœªè®€åœ¨å‰ï¼Œæ™‚é–“å€’åºåœ¨å¾Œ
            list.sort((a, b) => {
                const scoreA = (!a.acked) ? 2 : 1;
                const scoreB = (!b.acked) ? 2 : 1;
                if (scoreA !== scoreB) return scoreB - scoreA; 
                return (b.timestamp || 0) - (a.timestamp || 0);
            });

            // 3. æ¸²æŸ“ - çµ±ä¸€ä½¿ç”¨å°å¡æ¨£å¼
            list.forEach(g => {
                const d = document.createElement('div');
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå‰›å ±åˆ° (æœªè®€)ã€ï¼Œçµ¦äºˆä¸åŒ Classï¼Œä½†æ’ç‰ˆé‚è¼¯ä¸€è‡´
                let cardClass = 'vip-card';
                if (!g.acked) {
                    cardClass += ' new-arrival'; // åŠ ä¸Šé–ƒçˆé‚Šæ¡†
                }

                d.className = cardClass;
                d.onclick = function() { ackGuest(g.id); }; // é»æ“Šå¯æ¶ˆé™¤é–ƒçˆç‹€æ…‹
                d.style.cursor = "pointer";

                d.innerHTML = `
                    <img src="${g.photo||defaultAvatar}" class="avatar">
                    <div style="font-weight:bold;margin-bottom:5px;font-size:1.1rem;">${g.name}</div>
                    <div style="font-size:0.9rem;color:#666">${g.title}</div>
                `;
                grid.appendChild(d);
            });
        }

        function ackGuest(id) {
            db.ref(`events_data/${currentEventId}/${id}`).update({ acked: true });
        }

        // æ–°å¢ç¾å ´ä¾†è³“
        function addNewGuest() {
            Swal.fire({
                title: 'æ–°å¢ç¾å ´ä¾†è³“',
                html: `
                    <div style="text-align:left; font-size:0.9rem; color:#666; margin-bottom:5px;">å§“å</div>
                    <input id="swal-name" class="swal2-input" placeholder="è¼¸å…¥å§“å" style="margin:0 0 15px 0; width:80%;">
                    
                    <div style="text-align:left; font-size:0.9rem; color:#666; margin-bottom:5px;">è·ç¨±</div>
                    <input id="swal-title" class="swal2-input" placeholder="ä¾‹å¦‚ï¼šæœƒé•·ã€å±€é•·" style="margin:0 0 15px 0; width:80%;">
                    
                    <div style="text-align:left; font-size:0.9rem; color:#666; margin-bottom:5px;">åˆ†é¡ (æ±ºå®šè¼¸å‡ºç«¯æ˜¯å¦é¡¯ç¤º)</div>
                    <select id="swal-group" class="swal2-input" style="margin:0; width:80%;">
                        <option value="External">å‹æœƒè²´è³“ (External)</option>
                        <option value="Official">é•·å®˜/ä¾†è³“ (Official)</option>
                        <option value="Internal">æœ¬æœƒæœƒå“¡ (Internal)</option>
                        <option value="Member">ä¸€èˆ¬æœƒå“¡ (Member)</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'æ–°å¢ä¸¦ç›´æ¥å ±åˆ°',
                cancelButtonText: 'å–æ¶ˆ',
                focusConfirm: false,
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    const title = document.getElementById('swal-title').value;
                    const group = document.getElementById('swal-group').value;
                    if (!name) {
                        Swal.showValidationMessage('è«‹è¼¸å…¥å§“å');
                    }
                    return { name: name, title: title, group: group };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    const newId = "walkin_" + Date.now();
                    
                    db.ref(`events_data/${currentEventId}/${newId}`).set({
                        id: newId,
                        name: data.name,
                        title: data.title || 'è²´è³“',
                        group: data.group,
                        photo: "",
                        arrived: true,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        acked: false 
                    });

                    Swal.fire({ icon: 'success', title: 'æ–°å¢æˆåŠŸ', text: `${data.name} å·²å®Œæˆå ±åˆ°`, timer: 1500, showConfirmButton: false });
                }
            });
        }

        // è³‡æ–™åŒæ­¥èˆ‡åŒ¯å‡º
        function syncFromCloud() {
            if(!confirm("ç¢ºå®šå¾ Google é›²ç«¯åŒæ­¥ï¼Ÿ\n(å°‡åŒ¯å…¥ Internal/All_Data åˆ†é åå–®)")) return;
            Swal.fire({ title: 'åŒæ­¥ä¸­...', didOpen: () => Swal.showLoading() });
            fetch(`${GOOGLE_SCRIPT_URL}?op=get_all`).then(r => r.json()).then(data => {
                const newData = {};
                data.forEach(row => {
                    newData[row.id] = { id: row.id, name: row.name, title: row.title, group: row.group, photo: row.photo, arrived: false, timestamp: 0 };
                });
                db.ref(`events_data/${currentEventId}`).set(newData).then(() => Swal.fire("åŒæ­¥æˆåŠŸ", `åŒ¯å…¥ ${data.length} ç­†`, "success"));
            }).catch(()=> Swal.fire("å¤±æ•—", "æª¢æŸ¥è…³æœ¬éƒ¨ç½²", "error"));
        }
        function exportCSV() {
            let csv = "\uFEFFå§“å,è·ç¨±,ç‹€æ…‹,æ™‚é–“\n";
            Object.values(guestsData).forEach(g => { csv += `${g.name},${g.title},${g.arrived?'å·²åˆ°':'æœªåˆ°'},${g.arrived && g.timestamp ? new Date(g.timestamp).toLocaleTimeString() : ""}\n`; });
            const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); l.download = "record.csv"; l.click();
        }

        function showSiteQR() {
            document.getElementById('site-qr-modal').style.display = 'flex';
            document.getElementById('site-qrcode').innerHTML = '';
            var cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            var entryUrl = cleanUrl + "?mode=entry";
            new QRCode(document.getElementById('site-qrcode'), { text: entryUrl, width: 250, height: 250 });
        }
    </script>
</body>
</html>