<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCI æ´»å‹•ç®¡ç†ç³»çµ± V14 (ç¶“å…¸é‚„åŸ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --jci-blue: #0097D7; --jci-dark: #005780; --bg-gradient: linear-gradient(135deg, #0097D7 0%, #005780 100%); }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background: #f4f6f9; display: flex; flex-direction: column; height: 100vh; color: #333; }
        
        #nav-bar { background: rgba(255,255,255,0.95); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100;}
        .nav-item { cursor: pointer; padding: 8px 16px; border-radius: 50px; color: #666; font-weight: 500; transition: 0.3s; }
        .nav-item.active { background: var(--jci-blue); color: white; }

        .page { display: none; flex: 1; overflow-y: auto; padding: 20px; }
        .page.active { display: block; }

        /* Login */
        .login-card { background: white; width: 100%; max-width: 380px; padding: 40px; margin: 40px auto; border-radius: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .styled-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; background: #f9f9f9; }
        
        /* Dashboard */
        #dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .vip-card { background: white; border-radius: 20px; padding: 20px; text-align: center; border: 4px solid transparent; transition: 0.3s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .vip-card.active-light { border-color: #FFD700; background: #fffbef; box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); z-index: 10; transform: translateY(-5px); }
        .vip-card.acked-card { opacity: 0.6; filter: grayscale(80%); }
        .vip-card img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #eee; }

        /* Buttons */
        .btn-gradient { padding: 12px 20px; background: var(--bg-gradient); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; box-shadow: 0 5px 15px rgba(0,151,215,0.3); }
        .btn-tool { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; display: flex; align-items: center; gap: 5px; }

        #site-qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        #site-qr-box { background: white; padding: 30px; border-radius: 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="nav-bar">
        <div onclick="goPage('home')" style="cursor:pointer; font-weight:700;">ğŸ  æ´»å‹•å¤§å»³</div>
        <div style="display:flex; gap:10px;">
            <div class="nav-item" onclick="goPage('member')">æœƒå“¡</div>
            <div class="nav-item" onclick="goPage('reception')">è¼¸å…¥ç«¯</div>
            <div class="nav-item" onclick="goPage('dashboard')">è¼¸å‡ºç«¯</div>
        </div>
    </div>

    <div id="page-home" class="page active">
        <h2 style="color:#333;">ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
        <div id="event-list">è¼‰å…¥ä¸­...</div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn-gradient" style="width:auto;" onclick="createNewEvent()">+ å»ºç«‹æ´»å‹•</button>
            <button class="btn-gradient" style="width:auto; background:#fff; color:#333; border:1px solid #ccc;" onclick="showSiteQR()">ğŸ“± é¡¯ç¤ºå…¥å ´ QR</button>
        </div>
    </div>

    <div id="page-member" class="page">
        <div class="login-card">
            <h2 style="color:var(--jci-blue);">æœƒå“¡ç™»å…¥</h2>
            <div id="login-form">
                <input type="text" id="login-id" class="styled-input" placeholder="èº«åˆ†è­‰å­—è™Ÿ">
                <input type="text" id="login-dob" class="styled-input" placeholder="ç”Ÿæ—¥ (ä¾‹å¦‚: 19920105)">
                <button class="btn-gradient" onclick="verifyWithGoogle()">ç¢ºèªç™»å…¥</button>
            </div>
            <div id="pass-area" style="display:none; margin-top:20px;">
                <img id="pass-photo" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px; border:3px solid var(--jci-blue);">
                <h2 id="pass-name" style="margin:5px 0;"></h2>
                <div id="pass-title" style="color:#666; margin-bottom:15px;"></div>
                <div style="background:#fff; padding:10px; display:inline-block; border:1px solid #eee;"><div id="qrcode"></div></div>
                <button onclick="location.reload()" style="display:block; margin:20px auto; background:none; border:none; text-decoration:underline; color:#999; cursor:pointer;">é‡æ–°ç™»å…¥</button>
            </div>
        </div>
    </div>

    <div id="page-reception" class="page">
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
            <button class="btn-tool" style="background:orange;" onclick="toggleCamera()">ğŸ“· æƒæ</button>
            <button class="btn-tool" style="background:var(--jci-blue);" onclick="addNewGuest()">â• ä¾†è³“</button>
            <button class="btn-tool" style="background:#007bff;" onclick="syncFromCloud()">â˜ï¸ åŒæ­¥</button>
            <button class="btn-tool" style="background:#28a745;" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º</button>
            <button class="btn-tool" style="background:#dc3545; margin-left:auto;" onclick="deleteCurrentEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
        <div id="scanner-view" style="display:none; margin-bottom:15px; background:#000; border-radius:15px; overflow:hidden;"><div id="reader"></div></div>
        <input type="text" id="search-box" class="styled-input" placeholder="ğŸ” æœå°‹å§“å..." onkeyup="renderReception()" style="background:white;">
        <div id="reception-list"></div>
    </div>

    <div id="page-dashboard" class="page" style="background:#111; min-height:100vh;">
        <div id="dashboard-grid"></div>
    </div>

    <div id="site-qr-modal" onclick="this.style.display='none'">
        <div id="site-qr-box" onclick="event.stopPropagation()">
            <h2 style="color:var(--jci-blue);">æœƒå“¡å…¥å ´æƒç¢¼</h2>
            <div id="site-qr-target" style="margin:20px auto;"></div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜…â˜…â˜… è«‹åœ¨é€™è£¡è²¼ä¸Šä½ éƒ¨ç½²å¾Œçš„ GAS ç¶²å€ (çµå°¾æ˜¯ /exec) â˜…â˜…â˜…â˜…â˜…
        // é€™æ˜¯ V14 ç‰ˆæœ¬æœ€é—œéµçš„ä¸€æ­¥ï¼Œè²¼ä¸Šå°±ä¸æœƒéŒ¯
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyT00r1ap5CkHkuyj3htQ0-AuU65CkidhsxWftaNjWe_9iPgKs6HlaLfqBDPqkV2dUDMQ/exec"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        let currentEventId = null;
        let guestsData = {};
        let html5QrCode = null;

        // LH3 é€£çµè™•ç† (å‰ç«¯é¡¯ç¤ºç”¨)
        function getLH3(id) {
            if (!id) return defaultAvatar;
            return id.includes("http") ? id : "https://lh3.googleusercontent.com/d/" + id;
        }

        // é é¢æ§åˆ¶
        db.ref('events_meta').on('value', snap => {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            const data = snap.val() || {};
            Object.values(data).sort((a,b)=>b.created-a.created).forEach(evt => {
                const div = document.createElement('div');
                div.style = "background:white; padding:15px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";
                div.innerHTML = `<div><b>${evt.name}</b></div><button class="btn-tool" style="background:var(--jci-blue);" onclick="selectEvent('${evt.id}','${evt.name}')">é€²å…¥</button>`;
                list.appendChild(div);
            });
        });

        function goPage(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(p === 'member') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(p === 'reception') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(p === 'dashboard') document.querySelectorAll('.nav-item')[2].classList.add('active');
            if(p !== 'reception' && html5QrCode) { html5QrCode.stop().then(() => document.getElementById('scanner-view').style.display='none').catch(()=>{}); }
        }

        function selectEvent(id, name) {
            currentEventId = id;
            db.ref(`events_data/${id}`).on('value', snap => {
                guestsData = snap.val() || {};
                renderReception();
                renderDashboard();
            });
            goPage('reception');
        }

        // â˜…â˜…â˜… åŒæ­¥åå–® (V14 ç¶“å…¸æ¨¡å¼: Fetch + URL) â˜…â˜…â˜…
        function syncFromCloud() {
            if (!currentEventId) return Swal.fire("éŒ¯èª¤", "è«‹å…ˆé¸æ“‡æ´»å‹•", "error");
            if (GAS_API_URL.includes("è²¼åœ¨é€™è£¡")) return Swal.fire("è¨­å®šéŒ¯èª¤", "è«‹åœ¨ HTML ä»£ç¢¼ç¬¬ 170 è¡Œè²¼ä¸Š GAS ç¶²å€", "error");

            Swal.fire({ title: 'åŒæ­¥ä¸­...', didOpen: () => Swal.showLoading() });
            
            fetch(GAS_API_URL + "?op=get_all")
                .then(r => r.json())
                .then(data => {
                    const updates = {};
                    data.forEach(row => {
                        const existing = guestsData[row.id];
                        updates[row.id] = {
                            id: row.id, name: row.name, title: row.title, group: row.group,
                            photo: row.photo || "", 
                            arrived: existing ? existing.arrived : false, 
                            timestamp: existing ? existing.timestamp : 0,
                            acked: existing ? existing.acked : null
                        };
                    });
                    db.ref(`events_data/${currentEventId}`).update(updates)
                      .then(() => Swal.fire("æˆåŠŸ", `æ›´æ–° ${data.length} ç­†`, "success"));
                })
                .catch(e => Swal.fire("å¤±æ•—", "ç„¡æ³•é€£æ¥ GASï¼Œè«‹ç¢ºèªç¶²å€", "error"));
        }

        // â˜…â˜…â˜… æœƒå“¡ç™»å…¥ (V14 ç¶“å…¸æ¨¡å¼: Fetch + URL) â˜…â˜…â˜…
        function verifyWithGoogle() {
            const id = document.getElementById('login-id').value;
            const dob = document.getElementById('login-dob').value;
            if (GAS_API_URL.includes("è²¼åœ¨é€™è£¡")) return Swal.fire("è¨­å®šéŒ¯èª¤", "è«‹å…ˆå¡«å…¥ GAS ç¶²å€", "error");

            fetch(`${GAS_API_URL}?id=${id}&dob=${dob}`).then(r=>r.json()).then(d=>{
                if(d.status==='success') {
                    document.getElementById('login-form').style.display='none';
                    document.getElementById('pass-area').style.display='block';
                    document.getElementById('pass-name').innerText=d.name;
                    document.getElementById('pass-title').innerText=d.title;
                    document.getElementById('pass-photo').src=getLH3(d.photo);
                    document.getElementById('qrcode').innerHTML='';
                    new QRCode(document.getElementById('qrcode'), {text:d.uid, width:150, height:150});
                } else Swal.fire("å¤±æ•—", "è³‡æ–™ä¸ç¬¦", "error");
            }).catch(e => Swal.fire("éŒ¯èª¤", "é€£ç·šå¤±æ•—", "error"));
        }
        
        // â˜…â˜…â˜… ç”¢ç”Ÿå…¥å ´ QR (V14 ç¶“å…¸æ¨¡å¼: ä½¿ç”¨ GAS URL) â˜…â˜…â˜…
        function showSiteQR() {
            if (GAS_API_URL.includes("è²¼åœ¨é€™è£¡")) return Swal.fire("è¨­å®šéŒ¯èª¤", "è«‹å…ˆå¡«å…¥ GAS ç¶²å€", "error");
            document.getElementById('site-qr-modal').style.display = 'flex';
            document.getElementById('site-qr-target').innerHTML = '';
            new QRCode(document.getElementById('site-qr-target'), { text: GAS_API_URL + "?mode=entry", width: 250, height: 250 });
        }

        // å…¥å£åˆ¤æ–·
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'entry') {
                document.getElementById('nav-bar').style.display = 'none';
                goPage('member');
            }
        };

        // å…¶ä»–åŸºç¤åŠŸèƒ½ (æ–°å¢/åŒ¯å‡º/åˆªé™¤)
        function addNewGuest() {
            if (!currentEventId) return;
            Swal.fire({
                title: 'æ–°å¢ä¾†è³“',
                html: '<input id="sw-name" class="styled-input" placeholder="å§“å"><input id="sw-title" class="styled-input" placeholder="è·ç¨±"><select id="sw-group" class="styled-input"><option value="Official">è²´è³“</option><option value="External">å‹æœƒ</option><option value="Internal">æœ¬æœƒ</option></select>',
                showCancelButton: true, confirmButtonText: 'æ–°å¢',
                preConfirm: () => {
                    const name = document.getElementById('sw-name').value;
                    if (!name) return Swal.showValidationMessage('è«‹è¼¸å…¥å§“å');
                    return { name: name, title: document.getElementById('sw-title').value, group: document.getElementById('sw-group').value };
                }
            }).then(res => {
                if(res.isConfirmed) {
                    const id = "walkin_" + Date.now();
                    db.ref(`events_data/${currentEventId}/${id}`).set({ id: id, ...res.value, arrived: true, acked: false, timestamp: firebase.database.ServerValue.TIMESTAMP, photo: "" });
                }
            });
        }
        function exportCSV() {
            if (!currentEventId) return;
            let csv = "\uFEFFå§“å,è·ç¨±,ç¾¤çµ„,ç‹€æ…‹,æ™‚é–“\n";
            Object.values(guestsData).forEach(g => { csv += `${g.name},${g.title},${g.group},${g.arrived?'å·²å ±åˆ°':'æœªåˆ°'},${g.timestamp?new Date(g.timestamp).toLocaleString():''}\n`; });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download="list.csv"; link.click();
        }
        function deleteCurrentEvent() {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ")) {
                db.ref(`events_meta/${currentEventId}`).remove(); db.ref(`events_data/${currentEventId}`).remove();
                currentEventId=null; goPage('home');
            }
        }
        function renderReception() {
            const list = document.getElementById('reception-list');
            const search = document.getElementById('search-box').value.toUpperCase();
            list.innerHTML = '';
            Object.values(guestsData).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).forEach(g => {
                if(search && !(g.name.includes(search)||g.title.includes(search))) return;
                const d = document.createElement('div');
                d.style = "background:white; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;";
                d.innerHTML = `
                    <div style="display:flex;align-items:center;">
                        <img src="${getLH3(g.photo)}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;margin-right:15px;border:1px solid #ddd;" onerror="this.src='${defaultAvatar}'">
                        <div><div style="font-weight:bold;">${g.name}</div><div style="font-size:0.8rem;color:#666;">${g.title}</div></div>
                    </div>
                    <button class="btn-tool" style="background:${g.arrived?'#ccc':'var(--jci-blue)'}; width:auto;" onclick="checkIn('${g.id}', ${!g.arrived})">${g.arrived?'å–æ¶ˆ':'ç°½åˆ°'}</button>
                `;
                list.appendChild(d);
            });
        }
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            const list = Object.values(guestsData).filter(g => g.arrived && (['Official','External'].includes(g.group) || (['Internal','Member'].includes(g.group) && (g.title.includes('æœƒé•·')||g.title.includes('ä¸»å¸­')))));
            list.sort((a,b) => (!a.acked?0:1) - (!b.acked?0:1) || (b.timestamp - a.timestamp));
            list.forEach(g => {
                const d = document.createElement('div');
                d.className = `vip-card ${!g.acked?'active-light':'acked-card'}`;
                d.onclick = () => db.ref(`events_data/${currentEventId}/${g.id}`).update({ acked: true });
                d.innerHTML = `<img src="${getLH3(g.photo)}" onerror="this.src='${defaultAvatar}'"><div style="font-weight:bold;font-size:1.3rem;">${g.name}</div><div>${g.title}</div>`;
                grid.appendChild(d);
            });
        }
        function checkIn(id, status) {
            db.ref(`events_data/${currentEventId}/${id}`).update({ arrived: status, timestamp: status?firebase.database.ServerValue.TIMESTAMP:0, acked: status?false:null });
        }
        function toggleCamera() {
            const v = document.getElementById('scanner-view');
            if(v.style.display==='block') { if(html5QrCode) html5QrCode.stop(); v.style.display='none'; }
            else { v.style.display='block'; html5QrCode=new Html5Qrcode("reader"); html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:250}, (txt)=>{ if(guestsData[txt]) checkIn(txt,true); }); }
        }
    </script>
</body>
</html>