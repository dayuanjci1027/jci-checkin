<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCI æ´»å‹•ç®¡ç†ç³»çµ± V20.0 (ç¾å­¸å›æ­¸ç‰ˆ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --jci-blue: #0097D7; 
            --jci-dark: #005780; 
            --accent: #FFC107; 
            --bg-gradient: linear-gradient(135deg, #0097D7 0%, #005780 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            margin: 0; 
            background: #f4f6f9; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            color: #333;
        }
        
        /* --- é ‚éƒ¨å°èˆªåˆ— (ç»ç’ƒæ“¬æ…‹) --- */
        #nav-bar { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 12px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.05); 
            z-index: 1000; 
            position: sticky; 
            top: 0;
        }
        .nav-group { display: flex; gap: 8px; }
        .nav-item { 
            cursor: pointer; 
            padding: 8px 16px; 
            border-radius: 50px; 
            font-size: 0.9rem; 
            color: #666; 
            transition: all 0.3s ease; 
            font-weight: 500; 
        }
        .nav-item:hover { background: #eef2f5; color: var(--jci-blue); }
        .nav-item.active { background: var(--jci-blue); color: white; box-shadow: 0 4px 10px rgba(0,151,215,0.3); }

        .page { display: none; flex: 1; overflow-y: auto; padding: 20px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- â˜…â˜…â˜… ç¾åŒ–å›æ­¸ï¼šæœƒå“¡ç™»å…¥é è¨­è¨ˆ â˜…â˜…â˜… --- */
        .login-bg { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 80vh; 
        }
        .login-card { 
            background: white; 
            width: 100%; 
            max-width: 380px; 
            padding: 40px; 
            border-radius: 24px; 
            text-align: center; 
            box-shadow: var(--card-shadow); 
            position: relative; 
            overflow: hidden; 
        }
        /* é ‚éƒ¨è—è‰²è£é£¾æ¢ */
        .login-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; 
            height: 6px; 
            background: var(--bg-gradient); 
        }
        .login-title { font-size: 1.6rem; font-weight: 700; color: #333; margin-bottom: 5px; }
        .login-subtitle { font-size: 0.9rem; color: #888; margin-bottom: 25px; }

        .styled-input { 
            width: 100%; 
            padding: 14px 16px; 
            margin-bottom: 15px;
            border: 2px solid #eee; 
            border-radius: 12px; 
            font-size: 1rem; 
            box-sizing: border-box; 
            transition: 0.3s; 
            background: #f9f9f9;
        }
        .styled-input:focus { 
            border-color: var(--jci-blue); 
            background: #fff; 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(0,151,215,0.1);
        }

        /* é€šè¡Œè­‰æ¨£å¼ */
        #pass-area { 
            display: none; 
            margin-top: 20px; 
            border: 2px dashed #b3e5fc; 
            background: #e1f5fe;
            padding: 25px; 
            border-radius: 16px; 
            position: relative;
        }

        /* --- è¼¸å…¥ç«¯åˆ—è¡¨ --- */
        .guest-item { 
            background: white; 
            padding: 15px; 
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            border: 1px solid #f0f0f0;
            transition: transform 0.2s;
        }
        .guest-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .guest-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; background: #eee; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- è¼¸å‡ºç«¯å¡ç‰‡ --- */
        #dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 25px; 
            padding-bottom: 50px;
        }
        .vip-card { 
            background: white; border-radius: 20px; padding: 25px; text-align: center; border: 4px solid transparent; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        /* ç™¼äº®ç‰¹æ•ˆ */
        .vip-card.active-light { 
            border-color: #FFD700; 
            background: #fffbef;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 215, 0, 0.1); 
            z-index: 10; 
            transform: translateY(-5px);
        }
        .vip-card.acked-card { opacity: 0.6; filter: grayscale(80%); transform: scale(0.98); }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn-gradient { 
            padding: 14px 24px; 
            background: var(--bg-gradient); 
            color: white; border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 1rem; 
            width: 100%;
            box-shadow: 0 5px 15px rgba(0,151,215,0.3); 
            transition: 0.3s;
        }
        .btn-gradient:active { transform: scale(0.98); }
        
        .btn-tool { 
            padding: 10px 18px; 
            border: none; border-radius: 8px; 
            cursor: pointer; color: white; 
            font-weight: 600; font-size: 0.9rem; 
            display: flex; align-items: center; gap: 6px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #scanner-view { display: none; margin-bottom: 20px; background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="nav-bar">
        <div id="current-event-display" onclick="goPage('home')" style="cursor:pointer; font-weight:700; color:var(--jci-dark); display:flex; align-items:center; gap:8px;">
            <span style="font-size:1.2rem;">ğŸ </span> <span>é¸æ“‡æ´»å‹•</span>
        </div>
        <div class="nav-group">
            <div class="nav-item" onclick="goPage('member')">æœƒå“¡</div>
            <div class="nav-item" onclick="goPage('reception')">è¼¸å…¥ç«¯</div>
            <div class="nav-item" onclick="goPage('dashboard')">è¼¸å‡ºç«¯</div>
        </div>
    </div>

    <div id="page-home" class="page active">
        <div style="max-width:800px; margin:0 auto;">
            <h2 style="color:#333; margin-bottom:20px; font-size:1.5rem;">ğŸ“… æ´»å‹•å¤§å»³</h2>
            <div id="event-list">è¼‰å…¥ä¸­...</div>
            <button class="btn-gradient" style="margin-top:30px; width:auto; display:inline-block;" onclick="createNewEvent()">+ å»ºç«‹æ–°æ´»å‹•</button>
        </div>
    </div>

    <div id="page-member" class="page">
        <div class="login-bg">
            <div class="login-card">
                <div style="font-size:3rem; margin-bottom:10px;">ğŸ†”</div>
                <div class="login-title">æœƒå“¡å ±åˆ°ç³»çµ±</div>
                <div class="login-subtitle">JCI Event Check-in</div>
                
                <div id="login-form">
                    <input type="text" id="login-id" class="styled-input" placeholder="èº«åˆ†è­‰å­—è™Ÿ">
                    <input type="text" id="login-dob" class="styled-input" placeholder="ç”Ÿæ—¥ (ä¾‹å¦‚: 19920105)">
                    <button class="btn-gradient" style="margin-top:10px;" onclick="verifyWithGoogle()">ç¢ºèªç™»å…¥</button>
                </div>

                <div id="pass-area">
                    <img id="pass-photo" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px; border:3px solid var(--jci-blue); object-fit:cover;">
                    <h2 id="pass-name" style="margin:5px 0; color:var(--jci-dark);"></h2>
                    <p id="pass-title" style="color:#666; font-size:0.9rem; margin:0 0 15px 0;"></p>
                    <div style="background:white; padding:15px; border-radius:10px; display:inline-block; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                        <div id="qrcode"></div>
                    </div>
                    <p style="font-size:0.8rem; color:#888; margin-top:15px;">è«‹å‘æ«ƒå°å‡ºç¤ºæ­¤ç•«é¢</p>
                    <button onclick="location.reload()" style="background:none; border:none; text-decoration:underline; color:#999; cursor:pointer; margin-top:10px;">é‡æ–°ç™»å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-reception" class="page">
        <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
            <button class="btn-gradient" style="width:auto; background:linear-gradient(45deg, #ff9800, #f57c00);" onclick="toggleCamera()">ğŸ“· æƒæ</button>
            <button class="btn-tool" style="background:var(--jci-blue);" onclick="addNewGuest()">â• ä¾†è³“</button>
            <button class="btn-tool" style="background:#007bff;" onclick="syncFromCloud()">â˜ï¸ åŒæ­¥</button>
            <button class="btn-tool" style="background:#28a745;" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º</button>
            <button class="btn-tool" style="background:#dc3545; margin-left:auto;" onclick="deleteCurrentEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
        
        <div id="scanner-view"><div id="reader"></div></div>
        
        <input type="text" id="search-box" class="styled-input" placeholder="ğŸ” æœå°‹å§“åã€è·ç¨±..." onkeyup="renderReception()" style="background:white; margin-bottom:20px;">
        
        <div id="reception-list"></div>
    </div>

    <div id="page-dashboard" class="page" style="background:#111; min-height:100vh;">
        <div id="dashboard-grid"></div>
    </div>

    <script>
        /* --- åˆå§‹åŒ– --- */
        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db"
        };
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyY1tcF_pR1vtF3NU1S4W36dsCpfTKejIK0hJ7kYy4Tyqy2JhEb5JT6ipTVhZpJUIR-8w/exec";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        let currentEventId = null;
        let guestsData = {};
        let html5QrCode = null;

        /* --- æ ¸å¿ƒé‚è¼¯ --- */
        
        // 1. ç…§ç‰‡è½‰ LH3 (Google Drive ID -> åœ–ç‰‡ç¶²å€)
        function getLH3(id) {
            if (!id || id.trim() === "") return defaultAvatar;
            if (id.includes("http")) return id; 
            return "https://drive.google.com/thumbnail?sz=w500&id=" + id; // å‚™ç”¨æ–¹æ¡ˆ: thumbnail å…¶å¯¦æ¯” LH3 è·¨åŸŸæ›´ç©©
        }

        // 2. ç›£è½æ´»å‹•åˆ—è¡¨
        db.ref('events_meta').on('value', snap => {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            const data = snap.val() || {};
            Object.values(data).sort((a,b)=>b.created-a.created).forEach(evt => {
                const div = document.createElement('div');
                div.style = "background:white; padding:20px; border-radius:16px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.03); border:1px solid #eee;";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:700; font-size:1.1rem; color:#333;">${evt.name}</div>
                        <div style="font-size:0.85rem; color:#999; margin-top:4px;">${new Date(evt.created).toLocaleString()}</div>
                    </div> 
                    <button class="btn-tool" style="background:var(--jci-blue); color:white;" onclick="selectEvent('${evt.id}','${evt.name}')">é€²å…¥</button>
                `;
                list.appendChild(div);
            });
        });

        // 3. é é¢åˆ‡æ›
        function goPage(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(p === 'member') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(p === 'reception') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(p === 'dashboard') document.querySelectorAll('.nav-item')[2].classList.add('active');

            if(p !== 'reception' && html5QrCode) {
                html5QrCode.stop().then(() => { document.getElementById('scanner-view').style.display = 'none'; }).catch(err => {});
            }
        }

        function selectEvent(id, name) {
            currentEventId = id;
            document.getElementById('current-event-display').innerHTML = `<span style="font-size:1.2rem;">ğŸ“…</span> <span>${name}</span>`;
            db.ref(`events_data/${id}`).on('value', snap => {
                guestsData = snap.val() || {};
                renderReception();
                renderDashboard();
            });
            goPage('reception');
        }

        // 4. è¼¸å…¥ç«¯åŠŸèƒ½ (æ–°å¢/åŒ¯å‡º/åˆªé™¤)
        function addNewGuest() {
            if (!currentEventId) return Swal.fire("éŒ¯èª¤", "è«‹å…ˆé¸æ“‡æ´»å‹•", "error");
            
            Swal.fire({
                title: 'æ–°å¢ç¾å ´ä¾†è³“',
                html: `
                    <div style="text-align:left; color:#666; font-size:0.9rem; margin-bottom:5px;">å§“å</div>
                    <input id="sw-name" class="styled-input" placeholder="è¼¸å…¥å§“å" style="margin-bottom:15px;">
                    <div style="text-align:left; color:#666; font-size:0.9rem; margin-bottom:5px;">è·ç¨±</div>
                    <input id="sw-title" class="styled-input" placeholder="ä¾‹å¦‚ï¼šæœƒé•·" style="margin-bottom:15px;">
                    <div style="text-align:left; color:#666; font-size:0.9rem; margin-bottom:5px;">åˆ†é¡</div>
                    <select id="sw-group" class="styled-input">
                        <option value="Official">é•·å®˜/ä¾†è³“ (Official)</option>
                        <option value="External">å‹æœƒè²´è³“ (External)</option>
                        <option value="Internal">æœ¬æœƒæœƒå“¡ (Internal)</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'æ–°å¢ä¸¦ç°½åˆ°',
                confirmButtonColor: '#0097D7',
                preConfirm: () => {
                    const name = document.getElementById('sw-name').value;
                    if (!name) return Swal.showValidationMessage('å§“åç‚ºå¿…å¡«');
                    return {
                        name: name,
                        title: document.getElementById('sw-title').value || 'è²´è³“',
                        group: document.getElementById('sw-group').value
                    };
                }
            }).then((res) => {
                if (res.isConfirmed) {
                    const newId = "walkin_" + Date.now();
                    db.ref(`events_data/${currentEventId}/${newId}`).set({
                        id: newId, ...res.value, arrived: true, acked: false, timestamp: firebase.database.ServerValue.TIMESTAMP, photo: ""
                    });
                    Swal.fire({ icon: 'success', title: 'å·²æ–°å¢', showConfirmButton: false, timer: 1000 });
                }
            });
        }

        function exportCSV() {
            if (!currentEventId) return Swal.fire("æç¤º", "è«‹å…ˆé€²å…¥æ´»å‹•", "info");
            let csv = "\uFEFFå§“å,è·ç¨±,ç¾¤çµ„,ç‹€æ…‹,æ™‚é–“\n";
            Object.values(guestsData).forEach(g => {
                const timeStr = g.timestamp ? new Date(g.timestamp).toLocaleString() : "---";
                csv += `${g.name},${g.title},${g.group},${g.arrived?'å·²å ±åˆ°':'æœªåˆ°'},${timeStr}\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `JCI_ç°½åˆ°åå–®_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function deleteCurrentEvent() {
            if (!currentEventId) return;
            Swal.fire({
                title: 'ç¢ºå®šåˆªé™¤ï¼Ÿ', text: "è³‡æ–™ç„¡æ³•å¾©åŸ", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'åˆªé™¤'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`events_meta/${currentEventId}`).remove();
                    db.ref(`events_data/${currentEventId}`).remove();
                    currentEventId = null;
                    document.getElementById('current-event-display').innerHTML = `<span>ğŸ </span> <span>é¸æ“‡æ´»å‹•</span>`;
                    goPage('home');
                    Swal.fire("å·²åˆªé™¤", "", "success");
                }
            });
        }

        function syncFromCloud() {
            if (!currentEventId) return Swal.fire("éŒ¯èª¤", "è«‹å…ˆé¸æ“‡æ´»å‹•", "error");
            Swal.fire({ title: 'åŒæ­¥ä¸­...', didOpen: () => Swal.showLoading() });
            fetch(`${GOOGLE_SCRIPT_URL}?op=get_all`).then(r => r.json()).then(data => {
                const updates = {};
                data.forEach(row => {
                    const existing = guestsData[row.id];
                    updates[row.id] = {
                        id: row.id, name: row.name, title: row.title, group: row.group,
                        photo: row.photo || "", 
                        arrived: existing ? existing.arrived : false, 
                        timestamp: existing ? existing.timestamp : 0,
                        acked: existing ? existing.acked : null
                    };
                });
                db.ref(`events_data/${currentEventId}`).update(updates).then(() => Swal.fire("åŒæ­¥æˆåŠŸ", `æ›´æ–° ${data.length} ç­†`, "success"));
            });
        }

        function renderReception() {
            const list = document.getElementById('reception-list');
            const search = document.getElementById('search-box').value.toUpperCase();
            list.innerHTML = '';
            
            Object.values(guestsData).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)).forEach(g => {
                if (search && !(g.name.includes(search) || g.title.includes(search) || g.id.includes(search))) return;
                
                const d = document.createElement('div');
                d.className = 'guest-item';
                d.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <img src="${getLH3(g.photo)}" class="guest-avatar" onerror="this.src='${defaultAvatar}'">
                        <div>
                            <div style="font-weight:700; color:#333;">${g.name}</div>
                            <div style="font-size:0.85rem; color:#888;">${g.title} <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.75rem;">${g.group}</span></div>
                        </div>
                    </div>
                    <button class="btn-tool" style="background:${g.arrived?'#ccc':'var(--jci-blue)'}; width:auto; padding:6px 12px;" onclick="checkIn('${g.id}', ${!g.arrived})">
                        ${g.arrived?'å–æ¶ˆ':'ç°½åˆ°'}
                    </button>`;
                list.appendChild(d);
            });
        }

        // 5. è¼¸å‡ºç«¯
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            
            const list = Object.values(guestsData).filter(g => {
                if (!g.arrived) return false;
                if (['Official', 'External', 'Officials'].includes(g.group)) return true;
                if (['Internal', 'internal', 'Member'].includes(g.group)) return g.title.includes('æœƒé•·') || g.title.includes('ä¸»å¸­') || g.group === 'Internal';
                return false;
            });

            list.sort((a,b) => (!a.acked?0:1) - (!b.acked?0:1) || (b.timestamp - a.timestamp));
            
            list.forEach(g => {
                const d = document.createElement('div');
                d.className = `vip-card ${!g.acked ? 'active-light' : 'acked-card'}`;
                d.onclick = () => db.ref(`events_data/${currentEventId}/${g.id}`).update({ acked: true });
                d.innerHTML = `
                    <img src="${getLH3(g.photo)}" onerror="this.src='${defaultAvatar}'">
                    <div style="font-weight:bold; font-size:1.3rem; color:#333; margin-bottom:5px;">${g.name}</div>
                    <div style="color:#666; font-size:0.95rem;">${g.title}</div>
                    ${!g.acked ? '<div style="color:#e65100; font-weight:bold; font-size:0.8rem; margin-top:8px;">â˜… æœ€æ–°å ±åˆ°</div>' : ''}
                `;
                grid.appendChild(d);
            });
        }

        function checkIn(id, status) {
            db.ref(`events_data/${currentEventId}/${id}`).update({
                arrived: status, 
                timestamp: status ? firebase.database.ServerValue.TIMESTAMP : 0, 
                acked: status ? false : null
            });
            if(status) {
                 const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                 Toast.fire({ icon: 'success', title: 'å·²ç°½åˆ°' });
            }
        }

        // 6. ç›¸æ©Ÿ & é©—è­‰
        function toggleCamera() {
            const v = document.getElementById('scanner-view');
            if (v.style.display === 'block') {
                if(html5QrCode) html5QrCode.stop();
                v.style.display = 'none';
            } else {
                v.style.display = 'block';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                    if (guestsData[txt]) {
                        checkIn(txt, true);
                        Swal.fire({ title: guestsData[txt].name, text: 'å ±åˆ°æˆåŠŸï¼', icon: 'success', timer: 1000, showConfirmButton: false });
                    } else Swal.fire("éŒ¯èª¤", "ç„¡æ­¤åå–®", "error");
                }).catch(err => {
                    Swal.fire("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ", "è«‹æª¢æŸ¥æ¬Šé™æˆ–HTTPS", "error");
                    v.style.display = 'none';
                });
            }
        }

        function createNewEvent() {
            Swal.fire({ title: 'æ–°æ´»å‹•åç¨±', input: 'text', showCancelButton: true }).then(r => {
                if (r.value) {
                    const id = "evt_" + Date.now();
                    db.ref('events_meta/' + id).set({ id: id, name: r.value, created: Date.now() });
                }
            });
        }

        function verifyWithGoogle() {
            const id = document.getElementById('login-id').value.trim();
            const dob = document.getElementById('login-dob').value.trim();
            if(!id || !dob) return Swal.fire("æç¤º", "è«‹è¼¸å…¥å®Œæ•´è³‡æ–™", "info");
            
            const btn = document.querySelector('#page-member .btn-gradient');
            const originalText = btn.innerText;
            btn.innerText = "é©—è­‰ä¸­...";
            btn.disabled = true;

            fetch(`${GOOGLE_SCRIPT_URL}?id=${id}&dob=${dob}`).then(r => r.json()).then(d => {
                btn.innerText = originalText;
                btn.disabled = false;
                
                if (d.status === 'success') {
                    document.getElementById('login-form').style.display = 'none';
                    document.querySelector('.login-subtitle').style.display = 'none';
                    
                    const area = document.getElementById('pass-area');
                    area.style.display = 'block';
                    document.getElementById('pass-name').innerText = d.name;
                    document.getElementById('pass-title').innerText = d.title;
                    document.getElementById('pass-photo').src = getLH3(d.photo);
                    
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById('qrcode'), { text: d.uid, width: 150, height: 150, colorDark : "#005780" });
                } else Swal.fire("é©—è­‰å¤±æ•—", "è³‡æ–™ä¸æ­£ç¢º", "error"); 
            }).catch(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                Swal.fire("é€£ç·šéŒ¯èª¤", "è«‹æª¢æŸ¥ç¶²è·¯", "error");
            });
        }
    </script>
</body>
</html>