<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCI æ´»å‹•ç®¡ç†ç³»çµ± V19.0 (æœ€çµ‚ç©©å®šç‰ˆ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --jci-blue: #0097D7; --jci-dark: #005780; --accent: #FFC107; 
            --bg-gradient: linear-gradient(135deg, #0097D7 0%, #005780 100%);
        }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        
        /* é ‚éƒ¨å°èˆªåˆ— */
        #nav-bar { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; position: sticky; top:0; }
        .nav-group { display: flex; gap: 8px; }
        .nav-item { cursor: pointer; padding: 8px 15px; border-radius: 20px; font-size: 0.95rem; color: #555; transition: 0.3s; font-weight: 500; }
        .nav-item.active { background: var(--jci-blue); color: white; }

        .page { display: none; flex: 1; overflow-y: auto; padding: 20px; }
        .page.active { display: block; }

        /* è¼¸å…¥ç«¯åˆ—è¡¨æ¨£å¼ */
        .guest-item { background: white; padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .guest-item:hover { background: #f9f9f9; }
        .guest-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; margin-right: 15px; background: #eee; border: 1px solid #ddd; }
        .guest-info { flex: 1; display: flex; align-items: center; }

        /* è¼¸å‡ºç«¯å¡ç‰‡æ¨£å¼ (Dashboard) */
        #dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* éŸ¿æ‡‰å¼ï¼šè‡ªå‹•å¡«æ»¿ */
            gap: 20px; 
            padding-bottom: 50px;
        }
        .vip-card { 
            background: white; border-radius: 16px; padding: 20px; text-align: center; border: 4px solid transparent; 
            transition: all 0.3s ease; cursor: pointer; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        /* â˜…â˜…â˜… ä¿®æ­£ç‰¹æ•ˆï¼šç™¼äº®ä½†ä¸è®Šå¤§ â˜…â˜…â˜… */
        .vip-card.active-light { 
            border-color: #FFD700; /* é‡‘æ¡† */
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), inset 0 0 10px rgba(255, 215, 0, 0.2); 
            z-index: 10; 
            /* transform: scale(1.05); å·²ç§»é™¤ï¼Œç¢ºä¿ä¸è®Šå¤§ */
        }
        .vip-card img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 3px solid #f0f2f5; }
        .vip-card.acked-card { opacity: 0.6; filter: grayscale(50%); }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-gradient { padding: 12px 20px; background: var(--bg-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-tool { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* æƒææ¡† */
        #scanner-view { display: none; margin-bottom: 15px; background: #000; border-radius: 15px; overflow: hidden; position: relative; }
    </style>
</head>
<body>

    <div id="nav-bar">
        <div id="current-event-display" onclick="goPage('home')" style="cursor:pointer; font-weight:bold; color:var(--jci-dark); display:flex; align-items:center; gap:5px;">
            <span>ğŸ </span> <span>é¸æ“‡æ´»å‹•</span>
        </div>
        <div class="nav-group">
            <div class="nav-item" onclick="goPage('member')">æœƒå“¡</div>
            <div class="nav-item" onclick="goPage('reception')">è¼¸å…¥ç«¯</div>
            <div class="nav-item" onclick="goPage('dashboard')">è¼¸å‡ºç«¯</div>
        </div>
    </div>

    <div id="page-home" class="page active">
        <h2 style="color:#333;">ğŸ“… æ´»å‹•å¤§å»³</h2>
        <div id="event-list">è¼‰å…¥ä¸­...</div>
        <button class="btn-gradient" style="margin-top:20px;" onclick="createNewEvent()">+ å»ºç«‹æ–°æ´»å‹•</button>
    </div>

    <div id="page-member" class="page">
        <div style="max-width:400px; margin: 40px auto; background:white; padding:40px; border-radius:24px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.08);">
            <h2 style="color:var(--jci-blue); margin-bottom:20px;">æœƒå“¡ç™»å…¥</h2>
            <input type="text" id="login-id" placeholder="èº«åˆ†è­‰å­—è™Ÿ" class="swal2-input" style="width:100%; margin:10px 0;">
            <input type="text" id="login-dob" placeholder="ç”Ÿæ—¥ (ä¾‹å¦‚: 19920105)" class="swal2-input" style="width:100%; margin:10px 0;">
            <button class="btn-gradient" style="width:100%; margin-top:20px;" onclick="verifyWithGoogle()">ç¢ºèªç™»å…¥</button>
            
            <div id="pass-area" style="display:none; margin-top:30px; animation: fadeIn 0.5s;">
                <img id="pass-photo" style="width:120px; height:120px; border-radius:50%; margin-bottom:15px; border:4px solid var(--jci-blue);">
                <h2 id="pass-name" style="margin:5px 0; color:#333;"></h2>
                <p id="pass-title" style="color:#666; margin:0 0 15px 0;"></p>
                <div style="background:#f8f9fa; padding:15px; border-radius:15px; display:inline-block;">
                    <div id="qrcode"></div>
                </div>
                <p style="font-size:0.85rem; color:#888; margin-top:10px;">è«‹å‡ºç¤ºæ­¤ç•«é¢é€²è¡Œæƒç¢¼</p>
            </div>
        </div>
    </div>

    <div id="page-reception" class="page">
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
            <button class="btn-gradient" style="background:linear-gradient(45deg, #ff9800, #f57c00);" onclick="toggleCamera()">ğŸ“· æƒæ QR Code</button>
            <button class="btn-tool" style="background:var(--jci-blue);" onclick="addNewGuest()">â• ç¾å ´ä¾†è³“</button>
            <button class="btn-tool" style="background:#007bff;" onclick="syncFromCloud()">â˜ï¸ åŒæ­¥é›²ç«¯</button>
            <button class="btn-tool" style="background:#28a745;" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡ºåå–®</button>
            <button class="btn-tool" style="background:#dc3545; margin-left:auto;" onclick="deleteCurrentEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
        
        <div id="scanner-view"><div id="reader"></div></div>
        
        <input type="text" id="search-box" placeholder="ğŸ” æœå°‹å§“åã€è·ç¨±æˆ–ç·¨è™Ÿ..." onkeyup="renderReception()" style="width:100%; padding:14px; border:2px solid #eee; border-radius:12px; box-sizing:border-box; margin-bottom:15px; font-size:1rem; outline:none;">
        
        <div id="reception-list"></div>
    </div>

    <div id="page-dashboard" class="page" style="background:#1a1a1a; min-height:100vh;">
        <div id="dashboard-grid"></div>
    </div>

    <script>
        // --- 1. è¨­å®šèˆ‡åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db"
        };
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyY1tcF_pR1vtF3NU1S4W36dsCpfTKejIK0hJ7kYy4Tyqy2JhEb5JT6ipTVhZpJUIR-8w/exec";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        let currentEventId = null;
        let guestsData = {};
        let html5QrCode = null;

        // --- 2. é—œéµå‡½æ•¸ï¼šLH3 åœ–ç‰‡è½‰æ› (ä¿®æ­£ https èˆ‡ æ ¼å¼) ---
        function getLH3(id) {
            if (!id || id.trim() === "") return defaultAvatar;
            if (id.includes("http")) return id; // è‹¥å·²ç¶“æ˜¯é€£çµå‰‡ä¸è™•ç†
            
            // â˜…â˜…â˜… ä¿®æ­£é»ï¼šä½¿ç”¨ Drive æª”æ¡ˆçš„æ¨™æº– LH3 æ ¼å¼ï¼Œä¸¦å¼·åˆ¶ https â˜…â˜…â˜…
            // æ ¼å¼ï¼šhttps://lh3.googleusercontent.com/d/{ID}
            return "https://lh3.googleusercontent.com/d/" + id;
        }

        // --- 3. é é¢å°èˆªèˆ‡è³‡æ–™ç›£è½ ---
        db.ref('events_meta').on('value', snap => {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            const data = snap.val() || {};
            // æŒ‰å»ºç«‹æ™‚é–“å€’åºæ’åˆ—
            Object.values(data).sort((a,b)=>b.created-a.created).forEach(evt => {
                const div = document.createElement('div');
                div.style = "background:white; padding:18px; border-radius:15px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);";
                div.innerHTML = `
                    <div>
                        <b style="font-size:1.1rem; color:#333;">${evt.name}</b><br>
                        <small style="color:#999;">${new Date(evt.created).toLocaleString()}</small>
                    </div> 
                    <button class="btn-tool" style="background:var(--jci-blue); color:white;" onclick="selectEvent('${evt.id}','${evt.name}')">é€²å…¥ç®¡ç†</button>
                `;
                list.appendChild(div);
            });
        });

        function goPage(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            
            // æ›´æ–°å°èˆªåˆ—ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(p === 'member') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(p === 'reception') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(p === 'dashboard') document.querySelectorAll('.nav-item')[2].classList.add('active');

            // å¦‚æœé›¢é–‹è¼¸å…¥ç«¯ï¼Œé—œé–‰ç›¸æ©Ÿä»¥çœé›»
            if(p !== 'reception' && html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-view').style.display = 'none';
                }).catch(err => {});
            }
        }

        function selectEvent(id, name) {
            currentEventId = id;
            document.getElementById('current-event-display').innerHTML = `<span>ğŸ“…</span> <span>${name}</span>`;
            // ç›£è½è©²æ´»å‹•çš„è³‡æ–™è®Šæ›´
            db.ref(`events_data/${id}`).on('value', snap => {
                guestsData = snap.val() || {};
                renderReception();
                renderDashboard();
            });
            goPage('reception');
        }

        // --- 4. åŠŸèƒ½é‚è¼¯ (è¼¸å…¥ç«¯) ---

        // æ–°å¢ç¾å ´ä¾†è³“ (ä¿®æ­£æŒ‰éˆ•ç„¡åæ‡‰å•é¡Œ)
        function addNewGuest() {
            if (!currentEventId) return Swal.fire("éŒ¯èª¤", "è«‹å…ˆé¸æ“‡æ´»å‹•", "error");
            
            Swal.fire({
                title: 'æ–°å¢ç¾å ´ä¾†è³“',
                html: `
                    <div style="margin-bottom:10px; text-align:left; font-size:0.9rem; color:#666;">å§“å</div>
                    <input id="sw-name" class="swal2-input" placeholder="è«‹è¼¸å…¥å§“å" style="margin:0 0 15px 0; width:85%;">
                    
                    <div style="margin-bottom:10px; text-align:left; font-size:0.9rem; color:#666;">è·ç¨±</div>
                    <input id="sw-title" class="swal2-input" placeholder="ä¾‹å¦‚ï¼šæœƒé•·" style="margin:0 0 15px 0; width:85%;">
                    
                    <div style="margin-bottom:10px; text-align:left; font-size:0.9rem; color:#666;">é¡åˆ¥</div>
                    <select id="sw-group" class="swal2-input" style="margin:0 0 15px 0; width:85%;">
                        <option value="Official">é•·å®˜/ä¾†è³“ (Official)</option>
                        <option value="External">å‹æœƒè²´è³“ (External)</option>
                        <option value="Internal">æœ¬æœƒæœƒå“¡ (Internal)</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'æ–°å¢ä¸¦ç°½åˆ°',
                confirmButtonColor: '#0097D7',
                cancelButtonText: 'å–æ¶ˆ',
                focusConfirm: false,
                preConfirm: () => {
                    const name = document.getElementById('sw-name').value;
                    if (!name) return Swal.showValidationMessage('å§“åç‚ºå¿…å¡«æ¬„ä½');
                    return {
                        name: name,
                        title: document.getElementById('sw-title').value || 'è²´è³“',
                        group: document.getElementById('sw-group').value
                    };
                }
            }).then((res) => {
                if (res.isConfirmed) {
                    const newId = "walkin_" + Date.now();
                    db.ref(`events_data/${currentEventId}/${newId}`).set({
                        id: newId, 
                        ...res.value, 
                        arrived: true, 
                        acked: false, 
                        timestamp: firebase.database.ServerValue.TIMESTAMP, 
                        photo: ""
                    });
                    Swal.fire({ icon: 'success', title: 'å·²æ–°å¢', showConfirmButton: false, timer: 1000 });
                }
            });
        }

        // åŒ¯å‡º CSV (åŠŸèƒ½è£œå›)
        function exportCSV() {
            if (!currentEventId) return Swal.fire("æç¤º", "è«‹å…ˆé€²å…¥æ´»å‹•", "info");
            
            let csv = "\uFEFFå§“å,è·ç¨±,ç¾¤çµ„,å ±åˆ°ç‹€æ…‹,å ±åˆ°æ™‚é–“\n"; // \uFEFF è§£æ±º Excel ä¸­æ–‡äº‚ç¢¼
            Object.values(guestsData).forEach(g => {
                const timeStr = g.timestamp ? new Date(g.timestamp).toLocaleString() : "---";
                const statusStr = g.arrived ? 'å·²å ±åˆ°' : 'æœªåˆ°';
                csv += `${g.name},${g.title},${g.group},${statusStr},${timeStr}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `JCI_ç°½åˆ°åå–®_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // åˆªé™¤æ´»å‹• (åŠŸèƒ½è£œå›)
        function deleteCurrentEvent() {
            if (!currentEventId) return;
            Swal.fire({
                title: 'ç¢ºå®šè¦åˆªé™¤æ•´å€‹æ´»å‹•å—ï¼Ÿ',
                text: "æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'ç¢ºå®šåˆªé™¤',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`events_meta/${currentEventId}`).remove();
                    db.ref(`events_data/${currentEventId}`).remove();
                    currentEventId = null;
                    document.getElementById('current-event-display').innerHTML = `<span>ğŸ </span> <span>é¸æ“‡æ´»å‹•</span>`;
                    goPage('home');
                    Swal.fire("å·²åˆªé™¤", "æ´»å‹•è³‡æ–™å·²æ¸…ç©º", "success");
                }
            });
        }

        // åŒæ­¥é›²ç«¯ (è™•ç† LH3)
        function syncFromCloud() {
            if (!currentEventId) return Swal.fire("éŒ¯èª¤", "è«‹å…ˆé¸æ“‡æ´»å‹•", "error");
            
            Swal.fire({ title: 'æ­£åœ¨åŒæ­¥è³‡æ–™...', didOpen: () => Swal.showLoading() });
            
            fetch(`${GOOGLE_SCRIPT_URL}?op=get_all`).then(r => r.json()).then(data => {
                const updates = {};
                data.forEach(row => {
                    // åŒæ­¥æ™‚ä¸æ”¹è®Šå·²å ±åˆ°ç‹€æ…‹
                    const existing = guestsData[row.id];
                    updates[row.id] = {
                        id: row.id, 
                        name: row.name, 
                        title: row.title, 
                        group: row.group,
                        photo: row.photo || "", 
                        arrived: existing ? existing.arrived : false, 
                        timestamp: existing ? existing.timestamp : 0,
                        acked: existing ? existing.acked : null
                    };
                });
                db.ref(`events_data/${currentEventId}`).update(updates).then(() => Swal.fire("åŒæ­¥å®Œæˆ", `æˆåŠŸæ›´æ–° ${data.length} ç­†è³‡æ–™`, "success"));
            }).catch(e => Swal.fire("åŒæ­¥å¤±æ•—", "è«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®š", "error"));
        }

        // æ¸²æŸ“è¼¸å…¥ç«¯åˆ—è¡¨
        function renderReception() {
            const list = document.getElementById('reception-list');
            const search = document.getElementById('search-box').value.toUpperCase();
            list.innerHTML = '';
            
            // æ’åºï¼šæœ€æ–°å ±åˆ°çš„åœ¨æœ€ä¸Šé¢
            Object.values(guestsData).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)).forEach(g => {
                if (search && !(g.name.includes(search) || g.title.includes(search) || g.id.includes(search))) return;
                
                const d = document.createElement('div');
                d.className = 'guest-item';
                d.innerHTML = `
                    <div class="guest-info">
                        <img src="${getLH3(g.photo)}" class="guest-avatar" onerror="this.src='${defaultAvatar}'">
                        <div>
                            <div style="font-weight:bold; font-size:1.05rem;">${g.name}</div>
                            <div style="font-size:0.85rem; color:#666;">${g.title} <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.75rem;">${g.group}</span></div>
                        </div>
                    </div>
                    <button class="btn-tool" style="background:${g.arrived?'#ccc':'var(--jci-blue)'}; width:80px; justify-content:center;" onclick="checkIn('${g.id}', ${!g.arrived})">
                        ${g.arrived?'å–æ¶ˆ':'ç°½åˆ°'}
                    </button>`;
                list.appendChild(d);
            });
        }

        // --- 5. åŠŸèƒ½é‚è¼¯ (è¼¸å‡ºç«¯) ---
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            
            // ç¯©é¸é¡¯ç¤ºé‚è¼¯ï¼š
            // 1. å¿…é ˆå·²å ±åˆ° (arrived: true)
            // 2. ç¾¤çµ„ç‚º External, Official æˆ–æ˜¯ Internal ä¸­å«æœ‰ 'æœƒé•·'/'ä¸»å¸­'
            const list = Object.values(guestsData).filter(g => {
                if (!g.arrived) return false;
                if (['Official', 'External', 'Officials'].includes(g.group)) return true;
                if (['Internal', 'internal', 'Member'].includes(g.group)) {
                     // ç°¡å–®åˆ¤æ–·ï¼šé‡è¦è·å‹™æ‰é¡¯ç¤ºï¼Œè‹¥è¦å…¨éƒ¨é¡¯ç¤ºå¯æ‹¿æ‰æ­¤è¡Œ
                     return g.title.includes('æœƒé•·') || g.title.includes('ä¸»å¸­') || g.group === 'Internal'; 
                }
                return false;
            });

            // æ’åºï¼šæœªè®€(äº®ç‡ˆ)å„ªå…ˆ > æ™‚é–“å€’åº
            list.sort((a,b) => (!a.acked?0:1) - (!b.acked?0:1) || (b.timestamp - a.timestamp));
            
            list.forEach(g => {
                const d = document.createElement('div');
                d.className = `vip-card ${!g.acked ? 'active-light' : 'acked-card'}`;
                // é»æ“Šä»»ä½•åœ°æ–¹éƒ½å¯æ¶ˆç‡ˆ
                d.onclick = () => db.ref(`events_data/${currentEventId}/${g.id}`).update({ acked: true });
                
                d.innerHTML = `
                    <img src="${getLH3(g.photo)}" onerror="this.src='${defaultAvatar}'">
                    <div style="font-weight:bold; font-size:1.3rem; color:#333; margin-bottom:5px;">${g.name}</div>
                    <div style="color:#666; font-size:0.95rem;">${g.title}</div>
                    ${!g.acked ? '<div style="color:#d32f2f; font-weight:bold; font-size:0.8rem; margin-top:8px; animation:blink 1s infinite;">â— æœ€æ–°å ±åˆ°</div>' : ''}
                `;
                grid.appendChild(d);
            });
        }

        function checkIn(id, status) {
            db.ref(`events_data/${currentEventId}/${id}`).update({
                arrived: status, 
                timestamp: status ? firebase.database.ServerValue.TIMESTAMP : 0, 
                acked: status ? false : null
            });
            // å¦‚æœæ˜¯æ‰‹å‹•ç°½åˆ°ï¼Œçµ¦å€‹å°æç¤º
            if(status) {
                 const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                 Toast.fire({ icon: 'success', title: 'å·²ç°½åˆ°' });
            }
        }

        // --- 6. ç›¸æ©Ÿèˆ‡ç™»å…¥ ---
        function toggleCamera() {
            const v = document.getElementById('scanner-view');
            if (v.style.display === 'block') {
                if(html5QrCode) html5QrCode.stop();
                v.style.display = 'none';
            } else {
                v.style.display = 'block';
                html5QrCode = new Html5Qrcode("reader");
                // å¼·åˆ¶å¾Œé¡é ­
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                    if (guestsData[txt]) {
                        checkIn(txt, true);
                        Swal.fire({ title: guestsData[txt].name, text: 'å ±åˆ°æˆåŠŸï¼', icon: 'success', timer: 1000, showConfirmButton: false });
                    } else {
                        Swal.fire("éŒ¯èª¤", "æ‰¾ä¸åˆ°æ­¤åå–®", "error");
                    }
                }).catch(err => {
                    Swal.fire("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ", "è«‹ç¢ºèªç€è¦½å™¨æ¬Šé™æˆ–ä½¿ç”¨ HTTPS", "error");
                    v.style.display = 'none';
                });
            }
        }

        function createNewEvent() {
            Swal.fire({ title: 'è«‹è¼¸å…¥æ–°æ´»å‹•åç¨±', input: 'text', showCancelButton: true }).then(r => {
                if (r.value) {
                    const id = "evt_" + Date.now();
                    db.ref('events_meta/' + id).set({ id: id, name: r.value, created: Date.now() });
                }
            });
        }

        function verifyWithGoogle() {
            const id = document.getElementById('login-id').value.trim().toUpperCase();
            const dob = document.getElementById('login-dob').value.trim();
            if(!id || !dob) return Swal.fire("æç¤º", "è«‹è¼¸å…¥å®Œæ•´è³‡æ–™", "info");
            
            const btn = document.querySelector('#page-member .btn-gradient');
            const originalText = btn.innerText;
            btn.innerText = "é©—è­‰ä¸­...";
            btn.disabled = true;

            fetch(`${GOOGLE_SCRIPT_URL}?id=${id}&dob=${dob}`).then(r => r.json()).then(d => {
                btn.innerText = originalText;
                btn.disabled = false;
                
                if (d.status === 'success') {
                    // éš±è—è¼¸å…¥æ¡†ï¼Œé¡¯ç¤ºé€šè¡Œè­‰
                    document.getElementById('login-id').style.display = 'none';
                    document.getElementById('login-dob').style.display = 'none';
                    btn.style.display = 'none';
                    
                    const area = document.getElementById('pass-area');
                    area.style.display = 'block';
                    document.getElementById('pass-name').innerText = d.name;
                    document.getElementById('pass-title').innerText = d.title;
                    document.getElementById('pass-photo').src = getLH3(d.photo);
                    
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById('qrcode'), { text: d.uid, width: 150, height: 150, colorDark : "#005780" });
                } else { 
                    Swal.fire("é©—è­‰å¤±æ•—", "è³‡æ–™ä¸æ­£ç¢ºæˆ–ç„¡æ­¤æœƒå“¡", "error"); 
                }
            }).catch(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                Swal.fire("é€£ç·šéŒ¯èª¤", "è«‹æª¢æŸ¥ç¶²è·¯", "error");
            });
        }
    </script>
</body>
</html>