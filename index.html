<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JCI å ±åˆ°ç³»çµ± V2.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --jci-blue: #0097D7; 
            --jci-dark: #005780;
            --accent: #FFC107; 
            --bg-gradient: linear-gradient(135deg, #0097D7 0%, #005780 100%);
            --mc-bg: #fff8e1;
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; margin: 0; background: #f0f2f5; 
            height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }

        /* ç³»çµ±é–å®šé®ç½© */
        #system-lock-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 1); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .lock-card {
            background: white; padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15); max-width: 350px; width: 90%;
        }
        .lock-icon { font-size: 4rem; color: var(--jci-dark); margin-bottom: 20px; }

        /* å°èˆªåˆ— */
        #nav-bar { 
            background: rgba(255, 255, 255, 0.98); 
            padding: 8px 15px; display: flex; justify-content: flex-start; align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); z-index: 999; 
            position: sticky; top: 0; height: auto; min-height: 60px; gap: 10px;
        }
        
        .event-badge { 
            background: #333; color: white; padding: 8px 15px; border-radius: 20px; 
            font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 5px; 
            z-index: 1001; flex: 0 1 auto; width: fit-content; 
            white-space: normal; word-break: break-word; line-height: 1.3; text-align: left; max-width: 50%; 
        }
        
        .dev-signature {
            font-size: 0.8rem; color: #005780; font-weight: bold;
            background: #e1f5fe; padding: 4px 10px; border-radius: 20px;
            border: 1px solid #b3e5fc; white-space: nowrap;
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-left: auto; margin-right: 10px; flex-shrink: 0; 
        }
        
        .nav-group { display: flex; gap: 5px; }
        .nav-item { cursor: pointer; color: #666; font-weight: 500; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; transition: all 0.3s ease; white-space: nowrap; }
        .nav-item.active { background: var(--jci-blue); color: white; box-shadow: 0 2px 10px rgba(0,151,215,0.3); }
        
        .mobile-menu-btn { display: none; font-size: 1.8rem; cursor: pointer; color: var(--jci-dark); z-index: 1001; user-select: none; flex-shrink: 0; }
        
        .mobile-dropdown {
            display: none; position: absolute; top: 100%; left: 0; width: 100%;
            background: white; flex-direction: column; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-bottom: 1px solid #eee; animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 900px) {
            .nav-group { display: none; }
            .mobile-menu-btn { display: block; }
            .mobile-dropdown.show { display: flex; }
            .nav-item { border-radius: 0; padding: 15px; text-align: center; border-bottom: 1px solid #f5f5f5; font-size: 1.1rem; }
            .nav-item:last-child { border-bottom: none; }
            .nav-item.active { background: #e3f2fd; color: var(--jci-blue); box-shadow: none; }
            .event-badge { max-width: 60%; font-size: 0.85rem; padding: 6px 12px; }
            .dev-signature { flex-direction: column; align-items: flex-end; justify-content: center; font-size: 0.65rem; line-height: 1.1; padding: 0; background: transparent; border: none; box-shadow: none; margin-left: auto; margin-right: 5px; }
            .dev-signature span { display: block; text-align: right; }
        }

        .page { display: none; flex: 1; overflow-y: auto; padding: 20px; animation: fadeIn 0.4s ease-out; }
        /* V6.6 ä¿®æ­£ï¼šKiosk é é¢ç§»é™¤ padding ä»¥ä¾¿ Banner æ»¿ç‰ˆ */
        #page-kiosk.page { padding: 0; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .styled-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; text-align: center; }
        .btn-gradient { width: 100%; padding: 14px; background: var(--bg-gradient); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 5px; box-shadow: 0 5px 15px rgba(0,151,215,0.3); }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,151,215,0.4); }

        .event-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #eee; gap: 15px; }
        .event-card.active { background: #e3f2fd; border-color: var(--jci-blue); }
        .event-card.closed { background: #fff5f5; border-color: #ffcdd2; }
        .event-info { flex: 1; min-width: 0; text-align: left; }
        .event-btn { flex-shrink: 0; white-space: nowrap; background: var(--jci-blue); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        .guest-item { background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .guest-item.arrived { background: #f9f9f9; }
        .guest-photo-small { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; margin-right: 12px; }
        .manual-tag { font-size: 0.75rem; color: #856404; background-color: #fff3cd; padding: 2px 6px; border-radius: 4px; border: 1px solid #ffeeba; margin-left: 5px; white-space: nowrap; font-weight: bold; }

        #dashboard-grid { display: flex; flex-wrap: wrap; gap: 20px; padding: 10px; justify-content: center; }
        .vip-card { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 260px; flex-grow: 1; max-width: 320px; border: 4px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 5px solid #f0f2f5; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .vip-card.new-arrival { border-color: #ff3d00; background: #fff9c4; box-shadow: 0 0 40px rgba(255, 61, 0, 0.6); animation: distinctFlash 1.5s infinite alternate; transform: scale(1.05); z-index: 10; }
        @keyframes distinctFlash { 0% { border-color: #ff3d00; } 100% { border-color: #FFC107; } }

        /* å›åˆ°é ‚ç«¯æŒ‰éˆ• */
        #btn-back-to-top {
            display: none; position: fixed; bottom: 100px; right: 30px; width: 50px; height: 50px;
            background: rgba(0, 0, 0, 0.5); color: white; border-radius: 50%;
            align-items: center; justify-content: center; font-size: 1.5rem;
            cursor: pointer; z-index: 199; transition: 0.3s;
        }
        #btn-back-to-top:hover { background: rgba(0, 0, 0, 0.8); }

        /* å›åˆ°åº•éƒ¨æŒ‰éˆ• */
        #btn-scroll-to-bottom {
            display: none; position: fixed; bottom: 160px; right: 30px; width: 50px; height: 50px;
            background: rgba(0, 0, 0, 0.5); color: white; border-radius: 50%;
            align-items: center; justify-content: center; font-size: 1.5rem;
            cursor: pointer; z-index: 199; transition: 0.3s;
        }
        #btn-scroll-to-bottom:hover { background: rgba(0, 0, 0, 0.8); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--jci-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 20px rgba(0,151,215,0.4); cursor: pointer; z-index: 200; }
        #site-qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #site-qr-box { background: white; padding: 40px; border-radius: 20px; text-align: center; }

        /* KIOSK æ¨£å¼ */
        
        /* V6.6: å…¨æ–° BANNER æ¨£å¼ */
        .kiosk-main-banner {
            width: 100%;
            background: linear-gradient(135deg, #0097D7 0%, #005780 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            border-radius: 0 0 40px 40px; /* ä¸‹æ–¹åœ“è§’ */
        }
        .banner-title { font-size: 3rem; font-weight: bold; letter-spacing: 5px; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .banner-sub { font-size: 1.2rem; opacity: 0.9; letter-spacing: 2px; }

        .kiosk-waiting-box {
            background: white; padding: 40px 20px; border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); text-align: center;
            width: 90%; max-width: 500px;
            display: flex; flex-direction: column; align-items: center;
            border: 4px solid var(--jci-blue);
        }
        
        /* æƒç¢¼åœ–ç¤º SVG æ¨£å¼ */
        .pulse-ring {
            width: 160px; height: 160px; border-radius: 50%;
            background: #e3f2fd; display: flex; align-items: center; justify-content: center;
            margin-bottom: 30px; animation: pulse-ring 2s infinite;
        }
        .scan-svg-icon { width: 80px; height: 80px; fill: var(--jci-blue); }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(0, 151, 215, 0.4); } 70% { box-shadow: 0 0 0 30px rgba(0, 151, 215, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 151, 215, 0); } }

        /* æƒç¢¼ç›’è¼¸å…¥æ¡† (Kioskç”¨) */
        #kiosk-input {
            width: 90%; padding: 15px; font-size: 1.3rem; text-align: center;
            border: 2px solid #ddd; border-radius: 12px; background: #f9f9f9;
            margin-bottom: 20px; ime-mode: disabled;
        }
        #kiosk-input:focus {
            border-color: #00C853; background: #fff; box-shadow: 0 0 15px rgba(0,200,83,0.3);
            outline: none;
        }

        #kiosk-camera-btn { 
            width: 100%; padding: 15px; border-radius: 12px; font-size: 1.1rem; 
            background: #fff; color: #666; border: 2px solid #eee; 
            font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; 
        }
        #kiosk-camera-btn:hover { background: #eee; color: #333; }

        #kiosk-scanner-container { display: none; width: 100%; max-width: 500px; background: black; border-radius: 25px; overflow: hidden; margin: 20px auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        #kiosk-success-view { display: none; text-align: center; }
        .countdown-bar { height: 6px; background: #eee; width: 100%; margin-top: 25px; border-radius: 10px; overflow: hidden; }
        .countdown-fill { height: 100%; background: #28a745; width: 100%; transition: width 3s linear; }

        /* æƒç¢¼ç›’è—ç‰™é…å°æŒ‰éˆ• (å³ä¸‹è§’) */
        .bt-pair-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: #607d8b; color: white;
            padding: 10px 20px; border-radius: 30px;
            font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 1000; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px;
        }
        .bt-pair-btn:hover { background: #546e7a; transform: translateY(-2px); }

        .settings-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .settings-action-btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .settings-action-btn:active { transform: scale(0.98); }

        #reception-scan-result { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 99999; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .result-content { max-width: 400px; width: 90%; }
        .status-success { color: #28a745; }
        .status-warning { color: #ffc107; }

        /* MC Page Styles */
        .mc-layout { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; flex-wrap: wrap; }
        .mc-column { flex: 1; min-width: 300px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .mc-header { background: #005780; color: white; font-weight: bold; padding: 15px; font-size: 1.3rem; text-align: center; border-bottom: 3px solid #FFC107; letter-spacing: 1px; }
        .mc-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 1.1rem; }
        .mc-item:nth-child(even) { background: #fafafa; }
        .mc-time { font-size: 0.9rem; color: #666; background: #eee; padding: 4px 8px; border-radius: 6px; margin-right: 12px; font-weight: bold; min-width: 50px; text-align: center;}
        .mc-name { font-weight: bold; font-size: 1.5rem; margin-right: 10px; color: #333; }
        .mc-title { color: var(--jci-blue); font-weight: bold; font-size: 1.1rem; }

        /* æ´»å‹•çµæŸæ©«å¹… */
        #event-closed-banner {
            display: none;
            background: #d32f2f; color: white; text-align: center; padding: 10px;
            font-weight: bold; font-size: 1.1rem; position: sticky; 
            top: 0; z-index: 998;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

    <div id="system-lock-screen">
        <div class="lock-card">
            <div class="lock-icon">ğŸ”’</div>
            <h2 style="margin: 0 0 10px 0;">ç³»çµ±å·²é–å®š</h2>
            <p style="color:#666; margin-bottom:20px;">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥é€²å…¥</p>
            <input type="password" id="lock-password" class="styled-input" placeholder="å¯†ç¢¼">
            <button class="btn-gradient" onclick="unlockSystem()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="reception-scan-result">
        <div class="result-content">
            <div id="scan-icon" style="font-size: 5rem; line-height: 1;">âœ”</div>
            <h2 id="scan-status-text" style="margin:10px 0 0 0; font-size:2rem;">å ±åˆ°æˆåŠŸ</h2>
            <img id="scan-photo" class="avatar" style="width:150px; height:150px; margin-top:25px;" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'">
            <h1 id="scan-name" style="color:var(--jci-blue); margin:15px 0 5px 0; font-size:2.5rem;"></h1>
            <div id="scan-title" style="color:#666; font-size:1.5rem;"></div>
            <div class="countdown-bar"><div id="scan-countdown-fill" class="countdown-fill"></div></div>
            <p style="color:#999; margin-top:12px;">3 ç§’å¾Œè‡ªå‹•è¿”å›...</p>
        </div>
    </div>

    <div id="nav-bar">
        <div class="event-badge" onclick="goPage('home')" id="current-event-display">
            <span>ğŸ </span> å°šæœªé¸æ“‡æ´»å‹•
        </div>
        
        <div class="dev-signature">
            <span>ğŸ† 2023æœƒé•·</span>
            <span>æ—æŒ¯æš‰ è£½ä½œ</span>
        </div>

        <div class="mobile-menu-btn" onclick="toggleMenu()">â˜°</div>
        <div class="nav-group">
            <div class="nav-item" onclick="goPage('kiosk')">è‡ªåŠ©å ±åˆ°</div>
            <div class="nav-item" onclick="goPage('reception')">è¼¸å…¥ç«¯</div>
            <div class="nav-item" onclick="goPage('dashboard')">è¼¸å‡ºç«¯</div>
            <div class="nav-item" onclick="goPage('mc')">æœƒé•·ã€ä¸»å¸­é€²å ´åº</div>
        </div>
        <div class="mobile-dropdown" id="mobile-nav">
            <div style="padding:15px; text-align:center; color:#999; font-size:0.8rem; border-bottom:1px solid #eee;">JCI Check-in System V2.0</div>
            <div class="nav-item" onclick="showChangelog()">é–‹ç™¼æ—¥èªŒ</div>
            <div class="nav-item" onclick="goPage('kiosk')">è‡ªåŠ©å ±åˆ°</div>

            <div class="nav-item" onclick="goPage('reception')">è¼¸å…¥ç«¯</div>
            <div class="nav-item" onclick="goPage('dashboard')">è¼¸å‡ºç«¯</div>
            <div class="nav-item" onclick="goPage('mc')">æœƒé•·ã€ä¸»å¸­é€²å ´åº</div>
        </div>
    </div>

    <div id="event-closed-banner">ğŸ›‘ æ´»å‹•å·²çµæŸ (å ±åˆ°é—œé–‰ / å”¯è®€æ¨¡å¼)</div>

    <div id="page-home" class="page active">
        <h2 style="color:#333; text-align: center;">ğŸ“… æ´»å‹•åˆ—è¡¨</h2>
        <div id="event-list" style="max-width: 600px; margin: 0 auto;">è¼‰å…¥ä¸­...</div>
        <div class="fab" onclick="createNewEvent()">+</div>
    </div>

    <div id="page-kiosk" class="page">
        <div class="bt-pair-btn" onclick="showPairingQR()">
            <span>ğŸ“¶</span> æƒç¢¼ç›’è—ç‰™é€£ç·š
        </div>

        <div style="display:flex; flex-direction:column; align-items:center; min-height:80vh;">
            
            <div class="kiosk-main-banner">
                <div class="banner-title">JCI è‡ªåŠ©å ±åˆ°</div>
                <div class="banner-sub">æ­¡è¿è’è‡¨ï¼è«‹å‡ºç¤º QR Code</div>
            </div>

            <div id="kiosk-standby" class="kiosk-waiting-box" onclick="document.getElementById('kiosk-input').focus()">
                <div class="pulse-ring">
                    <svg class="scan-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm-6 8h-2v4h2v-4zm4 0h-2v4h2v-4zm-8 0H7v4h2v-4z"/>
                    </svg>
                </div>
                <div class="kiosk-instruction">ğŸ“¡ æƒç¢¼ç›’å¾…å‘½ä¸­</div>
                
                <input type="url" id="kiosk-input" inputmode="latin" 
                       placeholder="é»æ­¤å•Ÿç”¨ (è«‹åˆ‡æ›è‹±æ–‡è¼¸å…¥)" 
                       autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" autofocus>
                
                <div class="kiosk-sub-instruction" style="font-size:0.9rem; color:#d32f2f;">âš ï¸ å¦‚å‡ºç¾æ³¨éŸ³ï¼Œè«‹åˆ‡æ› iPad è¼¸å…¥æ³•</div>
                
                <div style="margin: 20px 0; color:#999;">- æˆ– -</div>
                
                <button id="kiosk-camera-btn" onclick="startKioskCamera()">
                    ğŸ“· é»é–‹é¡é ­æƒæ
                </button>
            </div>

            <div id="kiosk-scanner-container">
                <div style="color:white; padding:20px; text-align:center; font-size: 1.2rem; background: rgba(0,0,0,0.5);">è«‹å‡ºç¤ºæ‚¨çš„ QR Code</div>
                <div id="kiosk-reader" style="width:100%;"></div>
                <button onclick="stopKiosk()" style="width:100%; padding:20px; background:#444; color:white; border:none; cursor:pointer; font-size:1.2rem; font-weight: bold;">è¿”å› / å–æ¶ˆ</button>
            </div>

            <div id="kiosk-success-view" class="login-card" style="width:100%; max-width: 450px;">
                <div id="kiosk-icon" style="color:#28a745; font-size:6rem; line-height: 1;">âœ”</div>
                <h2 id="kiosk-status" style="margin:10px 0 0 0; font-size:2.2rem; color: #28a745;">å ±åˆ°æˆåŠŸ</h2>
                <img id="kiosk-photo" class="avatar" style="width:160px; height:160px; margin-top:25px;" src="" onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'">
                <h1 id="kiosk-name" style="color:var(--jci-blue); margin:15px 0 5px 0; font-size:2.8rem;"></h1>
                <div id="kiosk-title" style="color:#666; font-size:1.6rem;"></div>
                <div class="countdown-bar"><div id="countdown-fill" class="countdown-fill"></div></div>
                <p style="color:#999; margin-top:12px; font-size: 1rem;">3 ç§’å¾Œè‡ªå‹•è¿”å›...</p>
            </div>
        </div>
    </div>

    <div id="page-reception" class="page">
        <h2 style="margin-bottom:20px; text-align: center;">è¼¸å…¥ç«¯ (æ«ƒå°)</h2>
        
        <div id="btn-back-to-top" onclick="scrollToTop()">â–²</div>
        <div id="btn-scroll-to-bottom" onclick="scrollToBottom()">â–¼</div>
        
        <button id="btn-cam" class="btn-gradient" style="background:linear-gradient(45deg, #ff5722, #ff9800); margin-bottom:20px; font-size: 1.2rem;" onclick="toggleCamera()">ğŸ“· æƒæ QR (å¾Œé¡é ­)</button>
        
        <div style="background:white; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; border:1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <button onclick="addNewGuest()" style="background:var(--jci-blue); color:white; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:bold; flex:1; font-size: 1rem;">â• æ–°å¢ä¾†è³“</button>
            <button onclick="adminSettings()" style="background:#607d8b; color:white; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:bold; flex:1; font-size: 1rem;">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>

        <div id="scanner-view" style="display:none; background:black; padding:10px; border-radius:20px; margin-bottom:20px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);"><div id="reader" style="width:100%"></div></div>
        <div style="position:relative; margin-bottom:15px;"><input type="text" id="search-box" placeholder="ğŸ” æœå°‹å§“å æˆ– è·ç¨±..." class="styled-input" style="margin-bottom: 0; font-size: 1.1rem;" onkeyup="renderReception()"></div>
        <div id="reception-list"></div>
    </div>

    <div id="page-mc" class="page" style="background-color: var(--mc-bg);">
        <h2 style="color:var(--jci-dark); margin:0 0 20px 0; text-align: center; padding-bottom: 10px;">ğŸ¤ æœƒé•·ã€ä¸»å¸­é€²å ´åº</h2>
        
        <div class="mc-layout">
            <div class="mc-column">
                <div class="mc-header">ğŸ‘‘ æ­·å±†æœƒé•·é€²å ´åº (æ–°âœèˆŠ)</div>
                <div id="mc-list-presidents"></div>
            </div>
            <div class="mc-column">
                <div class="mc-header">ğŸ© æ­·å±†ä¸»å¸­é€²å ´åº (æ–°âœèˆŠ)</div>
                <div id="mc-list-chairmen"></div>
            </div>
        </div>

        <div id="mc-empty" style="text-align:center; color:#999; margin-top:50px; display:none; font-size: 1.5rem;">ç›®å‰ç„¡æœƒé•·/ä¸»å¸­é€²å ´</div>
    </div>

    <div id="page-dashboard" class="page" style="background-color: #222; min-height: 100vh;">
        <h2 style="color:white; margin:0 0 30px 0; text-align: center; font-size: 2.5rem; letter-spacing: 2px;">è²´è³“è’è‡¨ç‰†</h2>
        <div id="empty-msg" style="color:#666; text-align:center; margin-top:20%; font-size:1.8rem; display:none; font-weight: bold;">ç­‰å¾…è²´è³“è’è‡¨...</div>
        <div id="dashboard-grid"></div>
    </div>

    <div id="page-mc" class="page" style="background-color: var(--mc-bg);">
        <h2 style="color:var(--jci-dark); margin:0 0 20px 0; text-align: center; padding-bottom: 10px;">ğŸ¤ æœƒé•·ã€ä¸»å¸­é€²å ´åº</h2>
        <div class="mc-layout">
            <div class="mc-column">
                <div class="mc-header">ğŸ‘‘ æ­·å±†æœƒé•·é€²å ´åº (æ–°âœèˆŠ)</div>
                <div id="mc-list-presidents"></div>
            </div>
            <div class="mc-column">
                <div class="mc-header">ğŸ© æ­·å±†ä¸»å¸­é€²å ´åº (æ–°âœèˆŠ)</div>
                <div id="mc-list-chairmen"></div>
            </div>
        </div>
        <div id="mc-empty" style="text-align:center; color:#999; margin-top:50px; display:none; font-size: 1.5rem;">ç›®å‰ç„¡æœƒé•·/ä¸»å¸­é€²å ´</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db",
            measurementId: "G-SDY39SN348"
        };
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-ekAyhXD8FLUWv6Xnma2Uvn7htbJAULLGe_jjzVbhFCJkwBtilD5lH6UDVDu6drO0Sg/exec";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        function getPhotoUrl(url) {
            if (!url) return defaultAvatar;
            return url + (url.indexOf('?') > -1 ? '&' : '?') + 't=' + new Date().getTime();
        }

        let currentEventId = null;
        let guestsData = {};
        let allEvents = {};
        let html5QrCode = null; 
        let kioskQrCode = null; 
        let kioskTimeout = null; 
        let isScanning = false;
        let isScanningProcessing = false;
        let systemSettings = { locked: false, password: '123', checkin_closed: false };
        let kioskScanBuffer = "";
        let kioskBufferTimeout = null;

        db.ref('settings').on('value', snap => {
            if(snap.val()) {
                systemSettings = snap.val();
                checkSystemLock();
            } else {
                db.ref('settings').set({ locked: true, password: '1234', checkin_closed: false });
            }
        });

        // V4.9: ç›£è½æ´»å‹•è®Šå‹•
        db.ref('events_meta').on('value', snap => {
            allEvents = snap.val() || {};
            renderEventList();
            checkEventStatus(); 
        });

        function checkSystemLock() {
            if (!systemSettings.locked || sessionStorage.getItem('system_unlocked')) {
                document.getElementById('system-lock-screen').style.display = 'none';
                return;
            }
            document.getElementById('system-lock-screen').style.display = 'flex';
        }

        function checkEventStatus() {
            const banner = document.getElementById('event-closed-banner');
            if (currentEventId && allEvents[currentEventId] && allEvents[currentEventId].closed) {
                banner.style.display = 'block';
                const navHeight = document.getElementById('nav-bar').offsetHeight;
                banner.style.position = 'sticky';
                banner.style.top = navHeight + 'px';

                if (isScanning) stopCamera();
                if (kioskQrCode) stopKiosk();
            } else {
                banner.style.display = 'none';
            }
        }

        function unlockSystem() {
            const inputPwd = document.getElementById('lock-password').value;
            if (inputPwd === systemSettings.password) {
                sessionStorage.setItem('system_unlocked', 'true');
                document.getElementById('system-lock-screen').style.display = 'none';
                Swal.fire({ icon: 'success', title: 'ç™»å…¥æˆåŠŸ', timer: 1000, showConfirmButton: false });
            } else {
                Swal.fire('éŒ¯èª¤', 'å¯†ç¢¼ä¸æ­£ç¢º', 'error');
            }
        }

        function adminSettings() {
            let isCurrentEventClosed = false;
            if (currentEventId && allEvents[currentEventId] && allEvents[currentEventId].closed) {
                isCurrentEventClosed = true;
            }

            Swal.fire({
                title: 'âš™ï¸ ç³»çµ±è¨­å®š',
                html: `
                    <div style="text-align:left; margin-bottom:10px;">å…¨ç«™é–å®š: ${systemSettings.locked ? '<span style="color:red;font-weight:bold;">ğŸ”’ é–å®š</span>' : '<span style="color:green;font-weight:bold;">ğŸ”“ å…¬é–‹</span>'}</div>
                    <button id="toggle-lock-btn" class="btn-gradient" style="background:${systemSettings.locked?'#4caf50':'#f44336'}; margin-bottom:15px; padding:10px;">
                        ${systemSettings.locked ? 'ğŸ”“ è§£é™¤å…¨ç«™é–å®š' : 'ğŸ”’ å•Ÿç”¨å…¨ç«™é–å®š'}
                    </button>
                    
                    <hr>
                    
                    <button id="btn-edit-meta" class="btn-gradient" style="background:#607d8b; margin-bottom:15px; padding:10px; ${!currentEventId ? 'display:none;' : ''}">
                        âœï¸ ä¿®æ”¹æ´»å‹•è³‡è¨Š (åç¨±/æ—¥æœŸ/ä¸»å¸­)
                    </button>

                    <button id="btn-copy-invite" class="btn-gradient" style="background:var(--jci-blue); margin-bottom:15px; padding:10px; ${!currentEventId ? 'display:none;' : ''}">
                        ğŸ”— è¤‡è£½å¤–æœƒä¾†è³“é ç´„é€£çµ
                    </button>

                    <div style="text-align:left; margin-bottom:10px;">
                        ç›®å‰æ´»å‹• (${allEvents[currentEventId] ? allEvents[currentEventId].name : 'æœªé¸æ“‡'}): 
                        ${isCurrentEventClosed ? '<span style="color:red;font-weight:bold;">ğŸ›‘ å·²çµæŸ</span>' : '<span style="color:green;font-weight:bold;">ğŸŸ¢ é€²è¡Œä¸­</span>'}
                    </div>
                    <button id="toggle-close-btn" class="btn-gradient" style="background:${isCurrentEventClosed?'#2196f3':'#d32f2f'}; margin-bottom:15px; padding:10px; ${!currentEventId ? 'display:none;' : ''}">
                        ${isCurrentEventClosed ? 'ğŸŸ¢ é‡å•Ÿæ­¤æ´»å‹• (å…è¨±å ±åˆ°)' : 'ğŸ›‘ çµæŸæ­¤æ´»å‹• (é—œé–‰å ±åˆ°)'}
                    </button>

                    <hr>
                    <h3 style="font-size:1rem; color:#666; margin:15px 0 10px; text-align:left;">ğŸ“¦ è³‡æ–™ç®¡ç†</h3>
                    <div class="settings-btn-grid">
                        <button id="btn-sync" class="settings-action-btn" style="background:#007bff;">â˜ï¸ åŒæ­¥åå–®</button>
                        <button id="btn-export" class="settings-action-btn" style="background:#28a745;">ğŸ“¥ åŒ¯å‡ºç´€éŒ„</button>
                        <button id="btn-clear" class="settings-action-btn" style="background:#ff9800;">âš ï¸ æ¸…ç©ºåå–®</button>
                        <button id="btn-del-evt" class="settings-action-btn" style="background:#d32f2f;">ğŸ—‘ï¸ åˆªé™¤æ´»å‹•</button>
                    </div>
                    <hr>
                    <div style="text-align:left; margin-bottom:5px;">ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼:</div>
                    <input id="new-admin-pwd" class="swal2-input" placeholder="è¼¸å…¥æ–°å¯†ç¢¼" value="${systemSettings.password}">
                `,
                showCancelButton: true,
                confirmButtonText: 'å„²å­˜è®Šæ›´',
                didOpen: () => {
                    document.getElementById('toggle-lock-btn').onclick = () => {
                        const newStatus = !systemSettings.locked;
                        db.ref('settings/locked').set(newStatus);
                        Swal.close();
                        Swal.fire('æˆåŠŸ', newStatus ? 'ç³»çµ±å·²ä¸Šé–' : 'ç³»çµ±å·²å…¬é–‹', 'success');
                    };
                    
                    if(document.getElementById('btn-edit-meta')) {
                        document.getElementById('btn-edit-meta').onclick = () => {
                            if(!currentEventId) return;
                            const evt = allEvents[currentEventId];
                            Swal.fire({
                                title: 'ä¿®æ”¹æ´»å‹•è³‡è¨Š',
                                html: `
                                    <input id="edit-name" class="swal2-input" placeholder="æ´»å‹•åç¨±" value="${evt.name}">
                                    <input id="edit-date" type="date" class="swal2-input" style="margin-top:10px;" value="${evt.eventDate || ''}">
                                    <input id="edit-chair" class="swal2-input" placeholder="ä¸»å¸­å§“å" style="margin-top:10px;" value="${evt.chairman || ''}">
                                `,
                                showCancelButton: true,
                                confirmButtonText: 'æ›´æ–°',
                                preConfirm: () => {
                                    return {
                                        name: document.getElementById('edit-name').value,
                                        date: document.getElementById('edit-date').value,
                                        chair: document.getElementById('edit-chair').value
                                    };
                                }
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    db.ref('events_meta/' + currentEventId).update({
                                        name: result.value.name,
                                        eventDate: result.value.date,
                                        chairman: result.value.chair
                                    });
                                    Swal.fire('æˆåŠŸ', 'æ´»å‹•è³‡è¨Šå·²æ›´æ–°', 'success');
                                }
                            });
                        };
                    }

                    if(document.getElementById('btn-copy-invite')) {
                        document.getElementById('btn-copy-invite').onclick = () => {
                            if(!currentEventId) return;
                            const baseUrl = window.location.href.split('index.html')[0];
                            const inviteUrl = `${baseUrl}invite.html?event=${currentEventId}`;
                            
                            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
                            const el = document.createElement('textarea');
                            el.value = inviteUrl;
                            document.body.appendChild(el);
                            el.select();
                            document.execCommand('copy');
                            document.body.removeChild(el);
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'é€£çµå·²è¤‡è£½',
                                text: inviteUrl,
                                footer: '<span style="color:var(--jci-blue)">å¿«å‚³çµ¦å¤–æœƒä¾†è³“é ç´„å§ï¼</span>'
                            });
                        };
                    }

                    if(document.getElementById('toggle-close-btn')) {
                        document.getElementById('toggle-close-btn').onclick = () => {
                            if (!currentEventId) return;
                            const newStatus = !isCurrentEventClosed;
                            
                            // è¦éœ¸æ–°å¢ï¼šå¦‚æœæ´»å‹•é—œé–‰ï¼Œé€£å‹•åˆªé™¤ Google Drive ä¸Šçš„ç…§ç‰‡
                            if(newStatus === true) {
                                Swal.fire({
                                    title: 'ç¢ºå®šçµæŸæ´»å‹•ï¼Ÿ',
                                    text: "çµæŸå¾Œå°‡è‡ªå‹•åˆªé™¤æ‰€æœ‰ä¾†è³“ä¸Šå‚³çš„ç…§ç‰‡ä»¥ä¿è­·éš±ç§ï¼",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: 'ç¢ºå®šçµæŸ',
                                    cancelButtonText: 'å–æ¶ˆ'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        db.ref(`events_meta/${currentEventId}`).update({ closed: true });
                                        // å‘¼å« GAS Cleanup API
                                        fetch(GOOGLE_SCRIPT_URL, {
                                            method: 'POST',
                                            mode: 'no-cors',
                                            body: JSON.stringify({ action: 'cleanup', eventId: currentEventId })
                                        });
                                        Swal.fire('æ´»å‹•å·²çµæŸ', 'ä¾†è³“ç…§ç‰‡å·²åŒæ­¥å¾é›²ç«¯åˆªé™¤', 'success');
                                    }
                                });
                            } else {
                                db.ref(`events_meta/${currentEventId}`).update({ closed: false });
                                Swal.fire('æ´»å‹•å·²é‡å•Ÿ', '', 'success');
                            }
                        };
                    }

                    document.getElementById('btn-sync').onclick = () => { Swal.close(); syncFromCloud(); };
                    document.getElementById('btn-export').onclick = () => { exportCSV(); };
                    document.getElementById('btn-clear').onclick = () => { Swal.close(); clearGuestList(); };
                    document.getElementById('btn-del-evt').onclick = () => { Swal.close(); deleteEvent(); };
                },
                preConfirm: () => { return document.getElementById('new-admin-pwd').value; }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newPwd = result.value;
                    if(newPwd) { db.ref('settings/password').set(newPwd); Swal.fire('æˆåŠŸ', 'å¯†ç¢¼å·²æ›´æ–°', 'success'); }
                }
            });
        }

        db.ref('events_meta').on('value', snap => { allEvents = snap.val() || {}; renderEventList(); });

        function toggleMenu() { document.getElementById('mobile-nav').classList.toggle('show'); }

        function goPage(p) {
            if (!currentEventId && p !== 'home') return Swal.fire("è«‹å…ˆåœ¨æ´»å‹•å¤§å»³é¸æ“‡ä¸€å€‹æ´»å‹•");
            document.getElementById('mobile-nav').classList.remove('show');
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('.nav-group .nav-item').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('#mobile-nav .nav-item').forEach(e => e.classList.remove('active'));

            // è¦éœ¸ä¿®æ­£ï¼šåˆ‡æ›é é¢æ™‚é‡ç½®å›åˆ°é ‚ç«¯æŒ‰éˆ•
            document.getElementById('btn-back-to-top').style.display = 'none';

            const navMap = {'kiosk':0, 'reception':1, 'dashboard':2, 'mc':3};
            if(navMap[p] !== undefined) {
                const desktopItems = document.querySelectorAll('.nav-group .nav-item');
                if(desktopItems[navMap[p]]) desktopItems[navMap[p]].classList.add('active');
                const mobileItems = document.querySelectorAll('#mobile-nav .nav-item');
                if(mobileItems[navMap[p]]) mobileItems[navMap[p]].classList.add('active');
            }
            if(p !== 'reception') stopCamera(); 
            if(p !== 'kiosk') stopKiosk();
            
            // V6.6: Kiosk é é¢è‡ªå‹• focus
            if(p === 'kiosk') {
                setTimeout(() => { 
                    const input = document.getElementById('kiosk-input');
                    if(input) input.focus(); 
                }, 500);
            }
            
            if(p === 'mc') renderMC();

            checkSystemLock();
        }

        // è¦éœ¸æ–°å¢ï¼šå›åˆ°é ‚ç«¯é‚è¼¯
        function scrollToTop() {
            const page = document.getElementById('page-reception');
            page.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // è¦éœ¸æ–°å¢ï¼šå›åˆ°åº•éƒ¨é‚è¼¯
        function scrollToBottom() {
            const page = document.getElementById('page-reception');
            page.scrollTo({ top: page.scrollHeight, behavior: 'smooth' });
        }

        // ç›£è½æ»¾å‹•é¡¯ç¤ºæŒ‰éˆ•
        document.getElementById('page-reception').addEventListener('scroll', function() {
            const btnTop = document.getElementById('btn-back-to-top');
            const btnBottom = document.getElementById('btn-scroll-to-bottom');
            
            // é¡¯ç¤º/éš±è—å›åˆ°é ‚ç«¯
            if (this.scrollTop > 300) {
                btnTop.style.display = 'flex';
            } else {
                btnTop.style.display = 'none';
            }

            // é¡¯ç¤º/éš±è—å›åˆ°åº•éƒ¨
            if (this.scrollHeight - this.scrollTop - this.clientHeight < 100) {
                 btnBottom.style.display = 'none';
            } else {
                 btnBottom.style.display = 'flex';
            }
        });

        function showChangelog() {
            Swal.fire({
                title: 'é–‹ç™¼æ—¥èªŒ',
                html: `
                    <div style="text-align:left; max-height: 300px; overflow-y: auto;">
                        <h4 style="margin: 0 0 5px 0; color:var(--jci-blue);">V2.0 (é€²è¡Œä¸­)</h4>
                        <ul style="margin: 0 0 15px 0; padding-left: 20px; color:#666; font-size:0.9rem;">
                            <li>(å¾…æ›´æ–°...)</li>
                        </ul>
                        <h4 style="margin: 0 0 5px 0; color:var(--jci-blue);">V1.0</h4>
                        <ul style="margin: 0 0 15px 0; padding-left: 20px; color:#666; font-size:0.9rem;">
                            <li>é–‹ç™¼ QR Code ç°½åˆ°ç³»çµ±</li>
                            <li>åŠ å…¥è®€å– Google Sheet åŠŸèƒ½</li>
                            <li>æ•´åˆæœƒå“¡å¡ QR Codeï¼Œä¸€æƒæå³ç°½åˆ°</li>
                            <li>æœƒé•·ã€ä¸»å¸­é€²å ´åº (è‡ªå‹•ä¾å±†æ•¸/å¹´ä»½æ’åº)</li>
                            <li>è²´è³“å ±åˆ°ç‰† (å³æ™‚é¡¯ç¤ºå·²åˆ°è²´è³“)</li>
                        </ul>
                    </div>
                `,
                confirmButtonText: 'é—œé–‰'
            });
            toggleMenu(); // é—œé–‰æ‰‹æ©Ÿé¸å–®
        }

        function createNewEvent() {
            Swal.fire({ 
                title: 'å»ºç«‹æ–°æ´»å‹•', 
                html: `
                    <div style="margin-bottom:10px;">è«‹è¼¸å…¥æ´»å‹•è³‡è¨Š</div>
                    <input id="swal-evt-name" class="swal2-input" placeholder="æ´»å‹•åç¨± (å¿…å¡«)">
                    <input id="swal-evt-date" type="date" class="swal2-input" style="margin-top:10px;">
                    <input id="swal-evt-chair" class="swal2-input" placeholder="ä¸»å¸­å§“å (é¸å¡«)" style="margin-top:10px;">
                `, 
                showCancelButton: true,
                preConfirm: () => {
                    const name = document.getElementById('swal-evt-name').value;
                    const date = document.getElementById('swal-evt-date').value;
                    const chair = document.getElementById('swal-evt-chair').value;
                    if(!name) return Swal.showValidationMessage('è«‹è¼¸å…¥æ´»å‹•åç¨±');
                    return { name: name, date: date, chair: chair };
                }
            }).then((r) => {
                if (r.isConfirmed && r.value) {
                    const id = 'evt_' + Date.now();
                    db.ref('events_meta/' + id).set({ 
                        id: id, 
                        name: r.value.name, 
                        eventDate: r.value.date, 
                        chairman: r.value.chair, 
                        created: Date.now(), 
                        closed: false 
                    });
                    selectEvent(id, r.value.name);
                }
            });
        }

        function renderEventList() {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            Object.values(allEvents).sort((a,b)=>b.created-a.created).forEach(evt => {
                const div = document.createElement('div');
                const isClosed = evt.closed ? true : false;
                div.className = `event-card ${evt.id === currentEventId ? 'active' : ''} ${isClosed ? 'closed' : ''}`;
                
                const displayDate = evt.eventDate ? evt.eventDate : "(æœªè¨­å®šæ—¥æœŸ)";
                const displayChair = evt.chairman ? evt.chairman : "(æœªè¨­å®š)";
                const createdStr = new Date(evt.created).toLocaleDateString();

                div.innerHTML = `
                    <div class="event-info">
                        <div style="font-weight:bold; font-size: 1.2rem; margin-bottom: 5px; line-height:1.2;">
                            ${isClosed ? 'ğŸ”’ ' : ''}${evt.name}
                        </div>
                        <div style="font-size:0.95rem; color:#555; margin-bottom: 5px;">
                            ğŸ“… ${displayDate} Â |Â  ğŸ‘¤ ä¸»å¸­ï¼š${displayChair}
                        </div>
                        <div style="font-size:0.8rem; color:#999;">
                            å»ºæª”ï¼š${createdStr}
                            ${isClosed ? '<span style="color:red; font-weight:bold; margin-left:5px;">(å·²çµæŸ)</span>' : ''}
                        </div>
                    </div>
                    <button class="event-btn" onclick="selectEvent('${evt.id}','${evt.name}')">é€²å…¥æ´»å‹•</button>
                `;
                list.appendChild(div);
            });
        }

        function selectEvent(id, name) {
            currentEventId = id;
            document.getElementById('current-event-display').innerHTML = `<span>ğŸ“…</span> ${name}`;
            db.ref(`events_data/${id}`).off();
            db.ref(`events_data/${id}`).on('value', snap => {
                guestsData = snap.val() || {};
                renderReception();
                renderDashboard();
                renderMC(); 
            });
            checkEventStatus();
            goPage('reception');
        }

        // --- V6.5 KIOSK é›™æ¨¡é‚è¼¯ ---

        // V6.5: é¡¯ç¤ºé…å° QR Code
        function showPairingQR() {
            Swal.fire({
                title: 'è«‹æ‹¿çµ¦æƒç¢¼ç›’æƒç¢¼ä¸¦é€£ç·šè—ç‰™',
                imageUrl: 'pair.jpg', // â˜…â˜…â˜… é—œéµï¼šè«‹å‹™å¿…ä¸Šå‚³é€™å¼µåœ–ç‰‡ â˜…â˜…â˜…
                imageWidth: 200,
                imageAlt: 'Bluetooth Pairing Code',
                confirmButtonText: 'é—œé–‰',
                footer: '<span style="color:#666; font-size:0.8rem;">(è‹¥åœ–ç‰‡æœªé¡¯ç¤ºï¼Œè«‹ç¢ºèªæ˜¯å¦å·²ä¸Šå‚³ pair.jpg)</span>'
            });
        }

        function startKioskCamera() {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "è‡ªåŠ©å ±åˆ°å·²é—œé–‰", "warning");

            document.getElementById('kiosk-standby').style.display = 'none';
            document.getElementById('kiosk-success-view').style.display = 'none';
            document.getElementById('kiosk-scanner-container').style.display = 'block';
            kioskQrCode = new Html5Qrcode("kiosk-reader");
            kioskQrCode.start({ facingMode: "user" }, { fps: 10, qrbox: { width: 300, height: 300 } }, onKioskScanSuccess)
            .catch(err => { console.error(err); Swal.fire("ç„¡æ³•å•Ÿå‹•å‰é¡é ­", "è«‹ç¢ºèªæ¬Šé™æˆ–ä½¿ç”¨ HTTPS", "error"); stopKiosk(); });

            clearTimeout(kioskTimeout);
            kioskTimeout = setTimeout(stopKiosk, 15000); 
        }

        function stopKiosk() {
            if(kioskQrCode) { kioskQrCode.stop().then(()=>{ kioskQrCode.clear(); kioskQrCode = null; }); }
            document.getElementById('kiosk-scanner-container').style.display = 'none';
            document.getElementById('kiosk-standby').style.display = 'flex'; // å›åˆ°å¾…æ©Ÿç•«é¢
            document.getElementById('kiosk-success-view').style.display = 'none';
            
            // é‡æ–°æŠŠç„¦é»æ”¾å›è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ä¸‹ä¸€ä½ç”¨æƒç¢¼ç›’
            setTimeout(() => { document.getElementById('kiosk-input').focus(); }, 100);
            
            clearTimeout(kioskTimeout); 
        }

        function onKioskScanSuccess(uid) {
            handleKioskInput(uid); 
        }

        // V6.4: Kiosk é é¢çš„è¼¸å…¥ç›£è½
        document.addEventListener('keypress', function (e) {
            // å¦‚æœç¾åœ¨æ˜¯åœ¨ Kiosk é é¢
            if(document.getElementById('page-kiosk').classList.contains('active')) {
                // å¦‚æœç›¸æ©Ÿæ­£åœ¨é–‹è‘—ï¼Œå°±ä¸ç›£è½ (é¿å…è¡çª)
                if(document.getElementById('kiosk-scanner-container').style.display === 'block') return;

                const input = document.getElementById('kiosk-input');
                // ç¢ºä¿ç„¦é»åœ¨è¼¸å…¥æ¡†
                if(document.activeElement !== input) input.focus();

                if (e.key === 'Enter') {
                    const code = input.value.trim();
                    if(code) {
                        // V6.4: æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡
                        if (/[\u3105-\u3129\u02CA\u02C7\u02CB\u02D9]/.test(code)) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'è¼¸å…¥éŒ¯èª¤',
                                text: 'åµæ¸¬åˆ°æ³¨éŸ³ç¬¦è™Ÿï¼è«‹å°‡ iPad è¼¸å…¥æ³•åˆ‡æ›ç‚ºã€ŒEnglish (US)ã€',
                                timer: 3000
                            });
                            input.value = '';
                            return;
                        }
                        handleKioskInput(code);
                        input.value = '';
                    }
                }
            }
        });

        // V6.4: Kiosk çµ±ä¸€è™•ç†é‚è¼¯
        function handleKioskInput(uid) {
            clearTimeout(kioskTimeout); 
            if(kioskQrCode) { kioskQrCode.stop().then(()=>{ kioskQrCode.clear(); kioskQrCode = null; }); }
            
            // V6.4: æª¢æŸ¥æ³¨éŸ³
            if (/[\u3105-\u3129\u02CA\u02C7\u02CB\u02D9]/.test(uid)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'è¼¸å…¥éŒ¯èª¤',
                    text: 'åµæ¸¬åˆ°æ³¨éŸ³ç¬¦è™Ÿï¼è«‹å°‡ iPad è¼¸å…¥æ³•åˆ‡æ›ç‚ºã€ŒEnglish (US)ã€',
                    timer: 3000
                });
                return;
            }

            document.getElementById('kiosk-scanner-container').style.display = 'none';
            document.getElementById('kiosk-standby').style.display = 'none'; 

            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "å ±åˆ°ç„¡æ•ˆ", "error").then(() => stopKiosk());

            if(guestsData[uid]) {
                const g = guestsData[uid];
                const isDuplicate = g.arrived;
                if(!isDuplicate) checkIn(uid, true);

                document.getElementById('kiosk-success-view').style.display = 'block';
                document.getElementById('kiosk-photo').src = getPhotoUrl(g.photo);
                document.getElementById('kiosk-name').innerText = g.name;
                document.getElementById('kiosk-title').innerText = g.title;

                const statusText = document.getElementById('kiosk-status');
                const statusIcon = document.getElementById('kiosk-icon');
                if (isDuplicate) {
                    statusText.innerText = "å·²é‡è¤‡å ±åˆ°";
                    statusText.style.color = "#ffc107"; 
                    statusIcon.innerText = "âš ";
                    statusIcon.style.color = "#ffc107";
                } else {
                    statusText.innerText = "å ±åˆ°æˆåŠŸ";
                    statusText.style.color = "#28a745"; 
                    statusIcon.innerText = "âœ”";
                    statusIcon.style.color = "#28a745";
                }

                const fill = document.getElementById('countdown-fill');
                fill.style.transition = 'none'; fill.style.width = '100%';
                setTimeout(() => { fill.style.transition = 'width 3s linear'; fill.style.width = '0%'; }, 100);
                setTimeout(() => { stopKiosk(); }, 3000);
            } else { 
                Swal.fire({ icon: 'error', title: 'æƒæå¤±æ•—', text: 'æ­¤ QR Code ä¸åœ¨åå–®ä¸­: ' + uid, timer: 2000, showConfirmButton: false })
                .then(() => stopKiosk()); 
            }
        }

        // --- RECEPTION ç›¸é—œé‚è¼¯ ---

        function toggleCamera() { isScanning ? stopCamera() : startCamera(); }
        
        function startCamera() {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "æƒæåŠŸèƒ½å·²é—œé–‰", "warning");

            document.getElementById('scanner-view').style.display = 'block';
            document.getElementById('btn-cam').innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
            document.getElementById('btn-cam').style.background = "#333";
            isScanningProcessing = false;
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (uid)=>{
                if(isScanningProcessing) return; 
                isScanningProcessing = true;
                
                if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "æ“ä½œç„¡æ•ˆ", "error").then(() => { isScanningProcessing = false; stopCamera(); });

                if(guestsData[uid]) {
                    const g = guestsData[uid];
                    const isDuplicate = g.arrived;
                    if(!isDuplicate) { checkIn(uid, true); }
                    showReceptionResult(g, isDuplicate);
                    setTimeout(() => { closeReceptionResult(); isScanningProcessing = false; }, 3000);
                } else {
                    Swal.fire({ icon: 'error', title: 'éŒ¯èª¤', text: 'éæœ¬å ´åå–®', timer: 1500, showConfirmButton: false }).then(() => { isScanningProcessing = false; });
                }
            });
            isScanning = true;
        }

        function showReceptionResult(g, isDuplicate) {
            const overlay = document.getElementById('reception-scan-result');
            const icon = document.getElementById('scan-icon');
            const title = document.getElementById('scan-status-text');
            const fill = document.getElementById('scan-countdown-fill');
            document.getElementById('scan-photo').src = getPhotoUrl(g.photo);
            document.getElementById('scan-name').innerText = g.name;
            document.getElementById('scan-title').innerText = g.title;
            if(isDuplicate) { icon.innerText = "!"; icon.className = "status-warning"; title.innerText = "å·²é‡è¤‡å ±åˆ°"; title.className = "status-warning"; } 
            else { icon.innerText = "âœ”"; icon.className = "status-success"; title.innerText = "å ±åˆ°æˆåŠŸ"; title.className = "status-success"; }
            overlay.style.display = 'flex';
            fill.style.transition = 'none'; fill.style.width = '100%';
            setTimeout(() => { fill.style.transition = 'width 3s linear'; fill.style.width = '0%'; }, 50);
        }

        function closeReceptionResult() { document.getElementById('reception-scan-result').style.display = 'none'; }

        function stopCamera() {
            if(html5QrCode) { html5QrCode.stop().then(()=>{ html5QrCode.clear(); html5QrCode = null; }); }
            document.getElementById('scanner-view').style.display = 'none';
            document.getElementById('btn-cam').innerText = "ğŸ“· æƒæ QR (å¾Œé¡é ­)";
            document.getElementById('btn-cam').style.background = "linear-gradient(45deg, #ff5722, #ff9800)";
            document.getElementById('reception-scan-result').style.display = 'none';
            isScanning = false;
        }

        function renderReception() {
            const list = document.getElementById('reception-list');
            const search = document.getElementById('search-box').value.toUpperCase();
            list.innerHTML = '';
            
            const isEventClosed = (allEvents[currentEventId] && allEvents[currentEventId].closed);

            Object.values(guestsData).sort((a, b) => (a.originalIndex || 0) - (b.originalIndex || 0)).forEach(g => {
                if(search && g.name.indexOf(search) === -1 && (g.title || "").indexOf(search) === -1) return;
                
                const isManual = !String(g.id).startsWith('u');
                const manualTag = isManual ? '<span class="manual-tag">âš ï¸ éœ€äººå·¥</span>' : '';

                const btnStyle = isEventClosed 
                    ? "background:#999; cursor:not-allowed;" 
                    : (g.arrived ? "background:#ccc;" : "background:var(--jci-blue);");
                
                const delStyle = isEventClosed 
                    ? "background:#eee; color:#aaa; cursor:not-allowed;" 
                    : "background:#ffebee; color:#c62828;";

                const d = document.createElement('div');
                d.className = `guest-item ${g.arrived ? 'arrived' : ''}`;
                d.innerHTML = `<div style="display:flex; align-items:center;"><img src="${getPhotoUrl(g.photo)}" class="guest-photo-small" onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'"><div><div style="font-weight:bold; font-size:1.1rem;">${g.name}${manualTag}</div><div style="font-size:0.8rem;color:#666">${g.title} | ${g.group}</div></div></div>
                <div style="display:flex; gap:5px;">
                    <button onclick="checkIn('${g.id}',${!g.arrived})" style="padding:6px 15px;border:none;border-radius:20px;cursor:pointer;color:white;font-weight:bold;${btnStyle}">${g.arrived?'å–æ¶ˆ':'ç°½åˆ°'}</button>
                    <button onclick="deleteGuest('${g.id}')" style="padding:6px 10px;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;${delStyle}">ğŸ—‘ï¸</button>
                </div>`;
                list.appendChild(d);
            });
        }

        function deleteGuest(uid) {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "è³‡æ–™å·²é–å®šï¼Œç„¡æ³•åˆªé™¤", "warning");

            Swal.fire({ title: 'ç¢ºå®šåˆªé™¤?', text: "åˆªé™¤å¾Œç„¡æ³•å¾©åŸ", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'åˆªé™¤', cancelButtonText: 'å–æ¶ˆ' }).then((result) => {
                if (result.isConfirmed) { db.ref(`events_data/${currentEventId}/${uid}`).remove(); Swal.fire('å·²åˆªé™¤', '', 'success'); }
            })
        }

        function checkIn(id, status) {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "ç„¡æ³•è®Šæ›´ç°½åˆ°ç‹€æ…‹", "warning");

            db.ref(`events_data/${currentEventId}/${id}`).update({ arrived: status, timestamp: status ? firebase.database.ServerValue.TIMESTAMP : 0, acked: status ? false : null });
        }

        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            const emptyMsg = document.getElementById('empty-msg');
            grid.innerHTML = '';
            let list = Object.values(guestsData).filter(g => {
                if (!g.arrived) return false;
                
                // è¦éœ¸ä¿®æ­£ï¼šåªè¦è·ç¨±åŒ…å«ã€Œæœƒé•·ã€å…©å€‹å­—å°±ä¸Šç‰†ï¼Œä½†è¦æ’é™¤ã€Œå‰¯æœƒé•·ã€
                const title = g.title || "";
                if (title.indexOf('æœƒé•·') > -1 && title.indexOf('å‰¯æœƒé•·') === -1) {
                    return true;
                }
                
                return false;
            });
            if (list.length === 0) { emptyMsg.style.display = 'block'; return; } else { emptyMsg.style.display = 'none'; }
            list.sort((a, b) => {
                const scoreA = (!a.acked) ? 2 : 1; const scoreB = (!b.acked) ? 2 : 1;
                if (scoreA !== scoreB) return scoreB - scoreA; return (b.timestamp || 0) - (a.timestamp || 0);
            });
            list.forEach(g => {
                const d = document.createElement('div');
                let cardClass = 'vip-card'; if (!g.acked) cardClass += ' new-arrival';
                d.className = cardClass; d.onclick = function() { ackGuest(g.id); }; d.style.cursor = "pointer";
                d.innerHTML = `<img src="${getPhotoUrl(g.photo)}" class="avatar" onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'"><div style="font-weight:bold;margin-bottom:5px; font-size:2.5rem; line-height:1.2;">${g.name}</div><div style="font-size:1.5rem;color:#666;">${g.title}</div>`;
                grid.appendChild(d);
            });
        }

        // MC é é¢æ¸²æŸ“é‚è¼¯ (V3.5 å¾©åˆ»ç‰ˆï¼šæ¬Šé‡æ’åº)
        function renderMC() {
            const listP = document.getElementById('mc-list-presidents');
            const listC = document.getElementById('mc-list-chairmen');
            const emptyMsg = document.getElementById('mc-empty');
            
            if(!listP || !listC) return;

            listP.innerHTML = '';
            listC.innerHTML = '';
            
            // åªæŠ“å·²å ±åˆ°çš„
            let allArrived = Object.values(guestsData).filter(g => g.arrived);

            // â˜…â˜…â˜… V3.5 å¾©åˆ»é—œéµï¼šå±†æ•¸å„ªå…ˆé‚è¼¯ â˜…â˜…â˜…
            function parseWeight(title) {
                if(!title) return 0;
                if(title.indexOf("å‰µæœƒé•·") > -1) return 1; // å‰µæœƒé•·æœ€å° (æœ€å¾Œ)
                
                // 1. å…ˆæŠ“å±†æ•¸ (ä¾‹å¦‚ "35å±†" -> 35)
                const termMatch = title.match(/(\d+)\s*å±†/);
                if(termMatch) return parseInt(termMatch[1]); // ç›´æ¥å›å‚³ 35
                
                // 2. æ²’æŠ“åˆ°å±†æ•¸ï¼Œæ‰æŠ“å¹´ä»½ï¼Œä¸¦è‡ªå‹•æ›ç®— (ä¾‹å¦‚ 2023 -> 33)
                // é€™è£¡å‡è¨­ 1990 æ˜¯åŸºåº•ï¼Œä¾å¯¦éš›å±†æ•¸èª¿æ•´
                const yearMatch = title.match(/20\d{2}/);
                if(yearMatch) return parseInt(yearMatch[0]) - 1989; // ä¿®æ­£ï¼š1990å¹´æ˜¯å‰µæœƒ? å‡è¨­ 2023=34å±†ï¼Œ2023-1989=34
                // è‹¥ä¸çŸ¥åŸºåº•ï¼Œæš«ç”¨ 1990
                
                return 0;
            }

            // æ’åºï¼šæ•¸å­—å¤§çš„æ’å‰é¢ (Desc)
            const sortFn = (a, b) => parseWeight(b.title) - parseWeight(a.title);

            // åˆ†çµ„éæ¿¾ (ä¾èˆŠç‰ˆé‚è¼¯ï¼šå«"æœƒé•·"/"ä¸»å¸­" ä¸” å«"å±†"æˆ–"å¹´"æˆ–"å‰µæœƒ")
            // ç‚ºäº†ä¿éšªï¼Œé€™è£¡ç¨å¾®å¯¬é¬†ä¸€é»ï¼Œåªè¦æœ‰æœƒé•·/ä¸»å¸­å°±å¥½ï¼Œæ¬Šé‡ç®—å‡ºä¾†æ˜¯ 0 çš„æœƒæ’åœ¨æœ€å¾Œ
            // ä½†ä¾è€å¤§æŒ‡ç¤º "ä»¥å‰çš„ç¨‹å¼ç¢¼"ï¼ŒèˆŠç‰ˆæ˜¯ && title.indexOf("å±†") > -1
            // ä¸éæœ‰äº›å¯èƒ½å¯« "2023æœƒé•·"ï¼Œæ‰€ä»¥æˆ‘è¦æŠŠæ¢ä»¶æ”¹æˆ "æœ‰æ¬Šé‡ > 1" æˆ–è€… "å«å±†/å¹´/å‰µæœƒ"
            
            const presidents = allArrived.filter(g => {
                const t = g.title || "";
                return t.indexOf("æœƒé•·") > -1 && (t.indexOf("å±†") > -1 || t.indexOf("å¹´") > -1 || /\d{4}/.test(t) || t.indexOf("å‰µæœƒ") > -1);
            }).sort(sortFn);

            const chairmen = allArrived.filter(g => {
                const t = g.title || "";
                return t.indexOf("ä¸»å¸­") > -1 && (t.indexOf("å±†") > -1 || t.indexOf("å¹´") > -1 || /\d{4}/.test(t));
            }).sort(sortFn);

            if(presidents.length === 0 && chairmen.length === 0) {
                if(emptyMsg) emptyMsg.style.display = 'block';
                if(document.querySelector('.mc-layout')) document.querySelector('.mc-layout').style.display = 'none';
            } else {
                if(emptyMsg) emptyMsg.style.display = 'none';
                if(document.querySelector('.mc-layout')) document.querySelector('.mc-layout').style.display = 'flex';
            }

            function addItem(g, container) {
                const div = document.createElement('div'); 
                div.className = 'mc-item';
                let timeStr = ""; 
                if(g.timestamp) timeStr = new Date(g.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                div.innerHTML = `<div class="mc-time">${timeStr}</div><div class="mc-name">${g.name}</div><div class="mc-title">${g.title}</div>`;
                container.appendChild(div);
            }

            presidents.forEach(g => addItem(g, listP));
            chairmen.forEach(g => addItem(g, listC));
        }
        function ackGuest(id) { db.ref(`events_data/${currentEventId}/${id}`).update({ acked: true }); }
        
        function addNewGuest() {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "ç„¡æ³•æ–°å¢ä¾†è³“", "warning");

            Swal.fire({
                title: 'æ–°å¢ç¾å ´ä¾†è³“', html: `<div id="swal-form-grid"><input id="swal-name" class="swal-large-input" placeholder="å§“å"><input id="swal-title" class="swal-large-input" placeholder="è·ç¨±"><select id="swal-group" class="swal-large-input"><option value="External">å‹æœƒè²´è³“</option><option value="Official">é•·å®˜</option><option value="Internal">æœ¬æœƒæœƒå“¡</option></select></div>`,
                customClass: { popup: 'swal-wide-popup' }, showCancelButton: true, confirmButtonText: 'æ–°å¢',
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    if (!name) Swal.showValidationMessage('è«‹è¼¸å…¥å§“å');
                    return { name: name, title: document.getElementById('swal-title').value, group: document.getElementById('swal-group').value };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newId = "walkin_" + Date.now();
                    db.ref(`events_data/${currentEventId}/${newId}`).set({ id: newId, name: result.value.name, title: result.value.title || 'è²´è³“', group: result.value.group, photo: "", arrived: true, timestamp: firebase.database.ServerValue.TIMESTAMP, acked: false, originalIndex: 999999 });
                }
            });
        }

        function clearGuestList() {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "è³‡æ–™å·²é–å®š", "warning");

            if(!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰åå–®ï¼Ÿæ´»å‹•å°‡ä¿ç•™ï¼Œä½†ç°½åˆ°è³‡æ–™æœƒæ¶ˆå¤±ã€‚")) return;
            db.ref(`events_data/${currentEventId}`).remove().then(() => Swal.fire("å·²æ¸…ç©º", "åå–®å·²é‡ç½®", "success"));
        }

        function syncFromCloud() {
            if (allEvents[currentEventId] && allEvents[currentEventId].closed) return Swal.fire("æ´»å‹•å·²çµæŸ", "è³‡æ–™å·²é–å®šï¼Œç„¡æ³•åŒæ­¥", "warning");

            Swal.fire({
                title: 'è«‹é¸æ“‡åŒæ­¥ä¾†æº', text: "é€™å°‡æœƒè¦†è“‹ç›®å‰çš„åˆå§‹åå–®", icon: 'question', showCancelButton: true, confirmButtonText: 'åƒ…æœƒå…§æœƒå“¡ (Internal)', confirmButtonColor: '#0097D7', showDenyButton: true, denyButtonText: 'å…¨é«”åå–® (All Data)', denyButtonColor: '#28a745', cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isDismissed) return; 
                const onlyInternal = result.isConfirmed; 
                Swal.fire({ title: 'åŒæ­¥ä¸­...', didOpen: () => Swal.showLoading() });
                
                const typeParam = onlyInternal ? 'internal' : 'all'; 
                
                fetch(`${GOOGLE_SCRIPT_URL}?op=get_all&type=${typeParam}&_t=${new Date().getTime()}`).then(r => r.json()).then(data => {
                    if(data.status === 'error') return Swal.fire("éŒ¯èª¤", data.msg, "error");

                    const newData = {};
                    let count = 0;
                    data.forEach((row, index) => {
                        newData[row.id] = { id: row.id, name: row.name, title: row.title, group: row.group, photo: row.photo, arrived: false, timestamp: 0, originalIndex: index };
                        count++;
                    });
                    db.ref(`events_data/${currentEventId}`).set(newData).then(() => Swal.fire("åŒæ­¥æˆåŠŸ", `åŒ¯å…¥ ${count} ç­†`, "success"));
                });
            });
        }

        function exportCSV() {
            let eventName = "ç°½åˆ°è¡¨"; if (currentEventId && allEvents[currentEventId]) eventName = allEvents[currentEventId].name;
            const clean = (text) => String(text || "").replace(/,/g, ' ').replace(/\n/g, ' ').trim();
            let csv = "\uFEFFå§“å,è·ç¨±,åˆ†é¡,ç°½åˆ°ç‹€æ…‹,å ±åˆ°æ™‚é–“\n";
            Object.values(guestsData).sort((a, b) => (a.originalIndex || 0) - (b.originalIndex || 0)).forEach(g => {
                let statusStr = "", timeStr = "";
                if (g.arrived) { statusStr = "å·²åˆ°"; if (g.timestamp) { let d = new Date(g.timestamp); const pad = (n) => (n < 10 ? '0' + n : n); timeStr = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; } }
                csv += `${clean(g.name)},${clean(g.title)},${clean(g.group)},${statusStr},${timeStr}\n`;
            });
            const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); l.download = eventName + ".csv"; l.click();
        }
        function deleteEvent() {
            if(!currentEventId || !confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ")) return;
            db.ref(`events_meta/${currentEventId}`).remove(); db.ref(`events_data/${currentEventId}`).remove();
            currentEventId = null; document.getElementById('current-event-display').innerHTML = "<span>ğŸ </span> å°šæœªé¸æ“‡æ´»å‹•"; goPage('home');
        }
    </script>
</body>
</html>