<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’å•†æœƒå…¨èƒ½æ´»å‹•ç®¡ç†ç³»çµ± V10.0 (é›²ç«¯é©—è­‰ç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #1a237e; --accent: #ff6f00; --bg: #f4f6f8; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }

        /* å°èˆªåˆ— */
        #nav-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-group { display: flex; gap: 10px; }
        .nav-item { cursor: pointer; color: #666; font-weight: bold; padding: 8px 12px; border-radius: 8px; transition: 0.2s; }
        .nav-item.active { background: var(--primary); color: white; }
        .event-badge { background: var(--accent); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(255, 111, 0, 0.3); }

        /* é é¢å®¹å™¨ */
        .page { display: none; flex: 1; overflow-y: auto; padding: 20px; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* P0. æ´»å‹•å¤§å»³ */
        .event-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 6px solid #ccc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .event-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .event-card.active { border-left-color: var(--accent); background: #fff8e1; }

        /* P1. æœƒå“¡ç™»å…¥ */
        .login-card { background: white; padding: 40px 30px; border-radius: 15px; max-width: 400px; margin: 30px auto; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #fafafa; }
        .login-input:focus { border-color: var(--primary); background: white; outline: none; }
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }

        /* P2. æ¥å¾…æ«ƒå° */
        .guest-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .guest-item.arrived { border-left-color: var(--primary); background: #e8eaf6; }
        .btn-scan { width: 100%; padding: 15px; background: #ff5722; color: white; border: none; border-radius: 10px; font-weight: bold; margin-bottom: 15px; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3); }

        /* P3. ç°½åˆ°ç‰† */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .vip-card { background: white; padding: 20px; border-radius: 12px; text-align: center; opacity: 0.6; filter: grayscale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; }
        .vip-card.arrived { opacity: 1; filter: grayscale(0); border: 2px solid var(--primary); transform: scale(1.05); box-shadow: 0 10px 20px rgba(26, 35, 126, 0.2); }
        .vip-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 3px solid #eee; }

        /* æµ®å‹•æ–°å¢æŒ‰éˆ• */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 15px rgba(255, 111, 0, 0.4); cursor: pointer; z-index: 200; transition: 0.3s; }
        .fab:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="nav-bar">
        <div class="event-badge" onclick="goPage('home')" id="current-event-display">å°šæœªé¸æ“‡æ´»å‹•</div>
        <div class="nav-group">
            <div class="nav-item" onclick="goPage('member')">æœƒå“¡</div>
            <div class="nav-item" onclick="goPage('reception')">æ«ƒå°</div>
            <div class="nav-item" onclick="goPage('dashboard')">ç‰†é¢</div>
        </div>
    </div>

    <div id="page-home" class="page active">
        <h2 style="color:#333; margin-top:0;">ğŸ  æ´»å‹•åˆ—è¡¨</h2>
        <div id="event-list">è¼‰å…¥ä¸­...</div>
        <div class="fab" onclick="createNewEvent()">+</div>
    </div>

    <div id="page-member" class="page">
        <div class="login-card">
            <h2 style="margin-top:0; color:var(--primary);">æœƒå“¡é›»å­é€šè¡Œè­‰</h2>
            <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">é©—è­‰èº«åˆ†ä»¥å–å¾—æ‚¨çš„æ°¸ä¹… QR Code</p>
            
            <div id="login-form">
                <input type="text" id="login-id" class="login-input" placeholder="èº«åˆ†è­‰å­—è™Ÿ (ä¾‹å¦‚ A123456789)">
                <input type="text" id="login-dob" class="login-input" placeholder="å‡ºç”Ÿå¹´æœˆæ—¥ (ä¾‹å¦‚ 0660101)">
                <button id="btn-verify" class="btn-main" onclick="verifyWithGoogle()">é©—è­‰ç™»å…¥</button>
            </div>

            <div id="pass-area" style="display:none; margin-top:30px; border-top:1px dashed #ccc; padding-top:20px;">
                <div style="font-size:0.9rem; color:#666;">æ­¡è¿å›ä¾†</div>
                <div id="pass-name" style="font-weight:bold; color:var(--primary); font-size:1.4rem; margin-bottom:15px;"></div>
                <div id="qrcode" style="display:inline-block; border: 5px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.1);"></div>
                <p style="color:#d32f2f; font-size:0.8rem; margin-top:15px; font-weight:bold;">âš ï¸ æ­¤ç¢¼æ°¸ä¹…æœ‰æ•ˆï¼Œè«‹æˆªåœ–ä¿å­˜</p>
                <button onclick="location.reload()" style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer; margin-top:10px;">é‡æ–°ç™»å…¥</button>
            </div>
        </div>
    </div>

    <div id="page-reception" class="page">
        <button id="btn-cam" class="btn-scan" onclick="toggleCamera()">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
        
        <div id="scanner-view" style="display:none; background:black; padding:10px; border-radius:10px; margin-bottom:15px;">
            <div id="reader"></div>
        </div>
        
        <input type="text" id="search-box" placeholder="ğŸ” æœå°‹æœ¬å ´æ¬¡åå–® (å§“å)..." class="login-input" onkeyup="renderReception()">
        
        <div style="margin-top:10px; font-size:0.9rem; color:#666;">åå–®åˆ—è¡¨ï¼š</div>
        <div id="reception-list"></div>
    </div>

    <div id="page-dashboard" class="page">
        <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <label style="background:var(--primary); color:white; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">
                ğŸ“‚ åŒ¯å…¥æœ¬å ´æ¬¡ Excel åå–®
                <input type="file" style="display:none" onchange="importExcel(this)">
            </label>
            <button onclick="exportCSV()" style="border:1px solid #ccc; background:white; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“¥ åŒ¯å‡ºç´€éŒ„</button>
            <button onclick="deleteEvent()" style="border:1px solid #ffcdd2; color:#c62828; background:#ffebee; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin-left:auto;">ğŸ—‘ï¸ åˆªé™¤æ­¤æ´»å‹•</button>
        </div>
        
        <div id="dashboard-grid" class="grid"></div>
    </div>

    <script>
        // ==========================================
        // â˜…â˜…â˜… è¨­å®šå€ (è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„è³‡æ–™) â˜…â˜…â˜…
        // ==========================================
        
        // 1. Firebase Config (è«‹å¾ Firebase å¾Œå°è¤‡è£½)
        const firebaseConfig = {
  apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
  authDomain: "checkin2025-f0bb9.firebaseapp.com",
  databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "checkin2025-f0bb9",
  storageBucket: "checkin2025-f0bb9.firebasestorage.app",
  messagingSenderId: "526526638146",
  appId: "1:526526638146:web:c69e758e8b3c1d5990e5db",
  measurementId: "G-SDY39SN348"
};

        // 2. Google Apps Script ç¶²å€ (è«‹å¾ Apps Script éƒ¨ç½²å–å¾—)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyY1tcF_pR1vtF3NU1S4W36dsCpfTKejIK0hJ7kYy4Tyqy2JhEb5JT6ipTVhZpJUIR-8w/exec";

        // ==========================================
        // ç³»çµ±é‚è¼¯é–‹å§‹ (ä»¥ä¸‹ä¸ç”¨å‹•)
        // ==========================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

        let currentEventId = null;
        let guestsData = {};
        let allEvents = {};
        let scanner = null;
        let isScanning = false;

        // ç›£è½æ´»å‹•åˆ—è¡¨
        db.ref('events_meta').on('value', snap => {
            allEvents = snap.val() || {};
            renderEventList();
        });

        // ------------------------------------------
        // 0. æ´»å‹•å¤§å»³
        // ------------------------------------------
        function createNewEvent() {
            Swal.fire({ title: 'å»ºç«‹æ–°æ´»å‹•', input: 'text', inputLabel: 'è¼¸å…¥æ´»å‹•åç¨±', showCancelButton: true }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const id = 'evt_' + Date.now();
                    db.ref('events_meta/' + id).set({ id: id, name: result.value, created: Date.now() });
                    selectEvent(id, result.value);
                }
            });
        }
        function renderEventList() {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            if(Object.keys(allEvents).length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ç›®å‰ç„¡æ´»å‹•ï¼Œè«‹æŒ‰å³ä¸‹è§’ + æ–°å¢</div>'; return; }
            Object.values(allEvents).sort((a,b)=>b.created-a.created).forEach(evt => {
                const div = document.createElement('div');
                div.className = `event-card ${evt.id === currentEventId ? 'active' : ''}`;
                div.innerHTML = `<div><div style="font-weight:bold; font-size:1.1rem;">${evt.name}</div><div style="font-size:0.8rem; color:#888;">${new Date(evt.created).toLocaleDateString()}</div></div><button onclick="selectEvent('${evt.id}','${evt.name}')" style="background:var(--primary);color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer">é€²å…¥</button>`;
                list.appendChild(div);
            });
        }
        function selectEvent(id, name) {
            currentEventId = id;
            document.getElementById('current-event-display').innerText = `ç›®å‰ï¼š${name}`;
            db.ref(`events_data/${id}`).off();
            db.ref(`events_data/${id}`).on('value', snap => {
                guestsData = snap.val() || {};
                renderReception();
                renderDashboard();
            });
            goPage('reception');
            Swal.fire({ icon: 'success', title: `å·²åˆ‡æ›è‡³ï¼š${name}`, timer: 1000, showConfirmButton: false });
        }
        function deleteEvent() {
            if(!currentEventId || !confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼")) return;
            db.ref(`events_meta/${currentEventId}`).remove();
            db.ref(`events_data/${currentEventId}`).remove();
            currentEventId = null;
            document.getElementById('current-event-display').innerText = "å°šæœªé¸æ“‡æ´»å‹•";
            guestsData = {};
            goPage('home');
        }

        function goPage(p) {
            // æœƒå“¡é é¢ä¸éœ€è¦é¸æ´»å‹•ï¼Œå…¶ä»–é é¢éœ€è¦
            if (!currentEventId && p !== 'home' && p !== 'member') return Swal.fire("è«‹å…ˆåœ¨æ´»å‹•å¤§å»³é¸æ“‡ä¸€å€‹æ´»å‹•");
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            if(p !== 'reception') stopCamera();
        }

        // ------------------------------------------
        // 1. æœƒå“¡é©—è­‰ (Call Google GAS)
        // ------------------------------------------
        function verifyWithGoogle() {
            const id = document.getElementById('login-id').value.trim().toUpperCase();
            const dob = document.getElementById('login-dob').value.trim();
            const btn = document.getElementById('btn-verify');
            
            if (!id || !dob) return Swal.fire("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            
            btn.innerText = "é›²ç«¯é©—è­‰ä¸­..."; 
            btn.disabled = true;

            fetch(`${GOOGLE_SCRIPT_URL}?id=${id}&dob=${dob}`)
                .then(r => r.json())
                .then(data => {
                    btn.innerText = "é©—è­‰ç™»å…¥"; 
                    btn.disabled = false;
                    
                    if (data.status === 'success') {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('pass-area').style.display = 'block';
                        document.getElementById('pass-name').innerText = `${data.name} (${data.title})`;
                        document.getElementById('qrcode').innerHTML = '';
                        // ç”¢ç”ŸåŠ å¯† ID çš„ QR Code
                        new QRCode(document.getElementById('qrcode'), { 
                            text: data.uid, width: 180, height: 180,
                            colorDark : "#1a237e", colorLight : "#ffffff"
                        });
                        Swal.fire({ icon: 'success', title: 'é©—è­‰æˆåŠŸ', text: 'è«‹ä¿å­˜æ‚¨çš„ QR Code', showConfirmButton: false, timer: 1500 });
                    } else {
                        Swal.fire("é©—è­‰å¤±æ•—", "æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢º", "error");
                    }
                })
                .catch(err => {
                    btn.innerText = "é©—è­‰ç™»å…¥"; btn.disabled = false;
                    Swal.fire("é€£ç·šéŒ¯èª¤", "ç„¡æ³•é€£æ¥ Google ä¼ºæœå™¨", "error");
                });
        }

        // ------------------------------------------
        // 2. æ¥å¾…æ«ƒå°
        // ------------------------------------------
        function toggleCamera() { isScanning ? stopCamera() : startCamera(); }
        function startCamera() {
            document.getElementById('scanner-view').style.display = 'block';
            document.getElementById('btn-cam').innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
            document.getElementById('btn-cam').style.backgroundColor = "#333";
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(onScanSuccess);
            isScanning = true;
        }
        function stopCamera() {
            if(scanner) { scanner.clear(); scanner = null; }
            document.getElementById('scanner-view').style.display = 'none';
            document.getElementById('btn-cam').innerText = "ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ";
            document.getElementById('btn-cam').style.backgroundColor = "#ff5722";
            isScanning = false;
        }
        function onScanSuccess(uid) {
            // æ¯”å° UID
            if(guestsData[uid]) {
                if(!guestsData[uid].arrived) {
                    checkIn(uid, true);
                    Swal.fire({ icon: 'success', title: guestsData[uid].name, text: 'ç°½åˆ°æˆåŠŸ', timer: 1000, showConfirmButton: false });
                } else { Swal.fire("é‡è¤‡", "é€™ä½è²´è³“å·²å…¥å ´", "warning"); }
            } else { 
                Swal.fire({
                    icon: 'error', 
                    title: 'éæœ¬å ´åå–®', 
                    text: 'æ­¤ QR Code æœªåœ¨æœ¬æ¬¡æ´»å‹•åå–®ä¸­ (è«‹ç¢ºèªæ˜¯å¦åŒ¯å…¥æˆ–ç‚ºå‹æœƒä¾†è³“)',
                    footer: `æƒæåˆ°çš„ ID: ${uid}`
                }); 
            }
        }
        function renderReception() {
            const list = document.getElementById('reception-list');
            const search = document.getElementById('search-box').value.toUpperCase();
            list.innerHTML = '';
            Object.values(guestsData).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).forEach(g => {
                if(search && g.name.indexOf(search) === -1) return;
                const div = document.createElement('div');
                div.className = `guest-item ${g.arrived ? 'arrived' : ''}`;
                div.innerHTML = `<div><div style="font-weight:bold; font-size:1.1rem;">${g.name}</div><div style="font-size:0.8rem;color:#666">${g.title} | ${g.group}</div></div><button onclick="checkIn('${g.id}',${!g.arrived})" style="padding:8px 16px;border:none;border-radius:20px;cursor:pointer;background:${g.arrived?'#ccc':'var(--primary)'};color:white;font-weight:bold;">${g.arrived?'å–æ¶ˆ':'ç°½åˆ°'}</button>`;
                list.appendChild(div);
            });
        }
        function checkIn(id, status) {
            db.ref(`events_data/${currentEventId}/${id}`).update({ arrived: status, timestamp: status ? firebase.database.ServerValue.TIMESTAMP : 0 });
        }

        // ------------------------------------------
        // 3. ç‰†é¢ & åŒ¯å…¥åŒ¯å‡º
        // ------------------------------------------
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            Object.values(guestsData).forEach(g => {
                const div = document.createElement('div');
                div.className = `vip-card ${g.arrived ? 'arrived' : ''}`;
                div.innerHTML = `<img src="${g.photo||defaultAvatar}"><div style="font-weight:bold;margin:10px 0;font-size:1.1rem;">${g.name}</div><div style="font-size:0.9rem;color:#666">${g.title}</div>${g.arrived?'<div style="color:var(--primary);font-weight:bold;margin-top:5px">å·²åˆ°</div>':''}`;
                grid.appendChild(div);
            });
        }
        function importExcel(input) {
            const file = input.files[0];
            if(!file || !confirm("ç¢ºå®šè¦å°‡åå–®åŒ¯å…¥è‡³ã€"+document.getElementById('current-event-display').innerText+"ã€‘å—ï¼Ÿ\n(é€™æœƒè¦†è“‹ç¾æœ‰åå–®)")) return;
            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const newData = {};
                json.forEach((row, i) => {
                    // å¦‚æœæ²’æœ‰ç³»çµ±IDï¼Œå°±è‡ªå‹•ç·¨è™Ÿ (å»ºè­°ç¸½è¡¨è¦æœ‰ç³»çµ±ID)
                    const uid = row['ç³»çµ±ID'] || ('u' + (i+1).toString().padStart(3,'0'));
                    newData[uid] = { 
                        id: uid, 
                        name: row['å§“å'] || row['name'], 
                        title: row['è·ç¨±'] || row['title'], 
                        group: row['åˆ†é¡'] || row['group'] || 'guest', 
                        photo: row['ç…§ç‰‡'] || row['photo'] || '', 
                        arrived: false, 
                        timestamp: 0 
                    };
                });
                db.ref(`events_data/${currentEventId}`).set(newData).then(() => alert("åå–®åŒ¯å…¥æˆåŠŸï¼"));
            };
            reader.readAsArrayBuffer(file);
        }
        function exportCSV() {
            let csv = "\uFEFFå§“å,è·ç¨±,åˆ†é¡,ç‹€æ…‹,æ™‚é–“\n";
            Object.values(guestsData).forEach(g => { 
                const t = g.arrived && g.timestamp ? new Date(g.timestamp).toLocaleTimeString() : "";
                csv += `${g.name},${g.title},${g.group},${g.arrived?'å·²åˆ°':'æœªåˆ°'},${t}\n`; 
            });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download = `ç°½åˆ°è¡¨_${new Date().toLocaleDateString()}.csv`; link.click();
        }
    </script>
</body>
</html>