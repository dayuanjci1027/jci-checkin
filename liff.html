<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>JCI å¿«é€Ÿé€šé—œ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f2f5; text-align: center; padding: 20px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:90vh; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; transition: all 0.3s; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 1.3rem; font-weight: bold; cursor: pointer; margin-top: 25px; color: white; transition: 0.2s; letter-spacing: 2px; }
        .btn-blue { background: linear-gradient(135deg, #0097D7 0%, #005780 100%); box-shadow: 0 5px 20px rgba(0,151,215,0.4); }
        .btn-blue:active { transform: scale(0.95); }
        .avatar { width: 120px; height: 120px; border-radius: 50%; border: 5px solid #f0f2f5; margin-bottom: 15px; object-fit: cover; }
        .hidden { display: none; }
        .scan-line { height: 4px; width: 100%; background: #0097D7; animation: scan 1.5s infinite alternate; }
        @keyframes scan { from { transform: scaleX(0.2); opacity: 0.5; } to { transform: scaleX(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading-view" class="card">
        <div class="scan-line"></div>
        <h2 style="margin-top:20px;">èº«åˆ†è­˜åˆ¥ä¸­...</h2>
        <p style="color:#666;">è«‹ç¨å€™ï¼Œæ­£åœ¨é€£ç·šè³‡æ–™åº«</p>
    </div>

    <div id="checkin-view" class="card hidden">
        <img id="user-photo" class="avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png">
        <h2 id="user-name" style="margin-bottom:5px;"></h2>
        <span id="user-title" style="background:#eee; padding:4px 10px; border-radius:15px; font-size:0.9rem; color:#555;"></span>
        <hr style="border:0; border-top:1px dashed #ddd; margin:25px 0;">
        <div style="text-align:left; padding-left:10px;">
            <div style="font-size:0.8rem; color:#999;">ç›®å‰æ´»å‹•</div>
            <div id="event-name" style="font-size:1.1rem; font-weight:bold; color:#005780;"></div>
            <div id="event-date" style="font-size:0.9rem; color:#666;"></div>
        </div>
        <button id="btn-checkin" class="btn btn-blue" onclick="doCheckIn()">ğŸ‘† é»æˆ‘ç°½åˆ°</button>
    </div>

    <div id="success-view" class="card hidden" style="text-align:center;">
        <div style="font-size:5rem; color:#28a745; line-height:1;">âœ”</div>
        <h1 style="color:#28a745; margin:10px 0;">ç°½åˆ°æˆåŠŸ</h1>
        <p style="color:#666;">æ­¡è¿è’è‡¨ï¼</p>
        <p style="font-size:0.8rem; color:#999; margin-top:20px;">æ‚¨å¯ä»¥é—œé–‰æ­¤è¦–çª—äº†</p>
    </div>

    <script>
        const MY_LIFF_ID = "2008926390-8WXG7Jxq"; 
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyT00r1ap5CkHkuyj3htQ0-AuU65CkidhsxWftaNjWe_9iPgKs6HlaLfqBDPqkV2dUDMQ/exec";

        const firebaseConfig = {
            apiKey: "AIzaSyDLq7SrkQaCnjtsFArh0leKPJRbPFZTZnk",
            authDomain: "checkin2025-f0bb9.firebaseapp.com",
            databaseURL: "https://checkin2025-f0bb9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkin2025-f0bb9",
            storageBucket: "checkin2025-f0bb9.firebasestorage.app",
            messagingSenderId: "526526638146",
            appId: "1:526526638146:web:c69e758e8b3c1d5990e5db"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentEventId = "";
        let memberData = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            let urlId = urlParams.get('eventId');

            if (urlId) {
                localStorage.setItem('jci_target_event_id', urlId);
                currentEventId = urlId;
            } else {
                currentEventId = localStorage.getItem('jci_target_event_id');
            }

            if(!currentEventId) {
                return Swal.fire("éŒ¯èª¤", "ç„¡æ³•å–å¾—æ´»å‹• ID (è«‹é‡æ–°æƒæ QR Code)", "error");
            }

            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    if (window.location.search.indexOf('eventId') === -1) {
                         const cleanUrl = window.location.origin + window.location.pathname + "?eventId=" + currentEventId;
                         liff.login({ redirectUri: cleanUrl });
                    } else {
                         liff.login({ redirectUri: window.location.href });
                    }
                } else {
                    liff.getProfile().then(profile => {
                        verifyIdentity(profile.userId);
                    });
                }
            }).catch(err => {
                Swal.fire("éŒ¯èª¤", "LIFF åˆå§‹åŒ–å¤±æ•—: " + err, "error");
            });
        };

        function verifyIdentity(lineId) {
            fetch(`${GAS_API_URL}?op=verify_line&uid=${lineId}`)
                .then(res => res.json())
                .then(res => {
                    if (res.found) {
                        memberData = res.member;
                        renderCheckInPage(memberData);
                    } else {
                        document.getElementById('loading-view').classList.add('hidden');
                        Swal.fire({
                            icon: 'error',
                            title: 'ç„¡æ³•è­˜åˆ¥èº«åˆ†',
                            text: 'æ‚¨çš„ LINE å¸³è™Ÿå°šæœªç¶å®šæˆ–éæœ¬æœƒæœƒå“¡ã€‚',
                            footer: 'Line ID: ' + lineId
                        });
                    }
                })
                .catch(err => {
                    Swal.fire("é€£ç·šéŒ¯èª¤", "ç„¡æ³•é€£æ¥ä¼ºæœå™¨ï¼Œè«‹é‡è©¦", "error");
                });
        }

        function renderCheckInPage(mem) {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('checkin-view').classList.remove('hidden');

            document.getElementById('user-name').innerText = mem.name;
            document.getElementById('user-title').innerText = mem.title || "è²´è³“";
            if(mem.photo) document.getElementById('user-photo').src = mem.photo;

            db.ref('events_meta/' + currentEventId).once('value').then(snap => {
                const evt = snap.val();
                if(evt) {
                    document.getElementById('event-name').innerText = evt.name;
                    document.getElementById('event-date').innerText = evt.eventDate || "æœ¬æ—¥æ´»å‹•";
                }
            });
        }

        function doCheckIn() {
            if(!memberData || !currentEventId) return;
            const btn = document.getElementById('btn-checkin');
            btn.disabled = true; btn.innerText = "å¯«å…¥ä¸­...";

            const checkInRef = db.ref(`events_data/${currentEventId}/${memberData.id}`);
            checkInRef.update({
                arrived: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                acked: false
            }).then(() => {
                document.getElementById('checkin-view').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                if (navigator.vibrate) navigator.vibrate(200);
            }).catch(err => {
                Swal.fire("ç°½åˆ°å¤±æ•—", err.message, "error");
                btn.disabled = false; btn.innerText = "ğŸ‘† é»æˆ‘ç°½åˆ°";
            });
        }
    </script>
</body>
</html>